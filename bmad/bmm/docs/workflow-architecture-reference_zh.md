# 决策架构工作流 - 技术参考

**模块：** BMM（BMAD方法模块）
**类型：** 解决方案设计工作流

---

## 概览

决策架构工作流是对BMAD方法中架构决策制定方式的完全重新构想。不是模板驱动的文档，这个工作流促进智能对话，产生**决策聚焦的架构文档**，为防止实施期间AI代理冲突进行了优化。

---

## 核心理念

**问题**：当多个AI代理实施系统的不同部分时，他们会做出冲突的技术决策，导致不兼容的实施。

**解决方案**：记录所有关键技术决策前期的"一致性合约"，确保每个代理遵循相同的模式并使用相同的技术。

---

## 关键特性

### 1. 启动模板智能 ⭐ 新增

- 发现相关的启动模板（create-next-app、create-t3-app等）
- 选择模板时考虑UX需求（动画、可访问性等）
- 搜索当前CLI选项和默认值
- 记录启动模板做出的决策
- 在启动基础周围做出剩余的架构决策
- 第一个实施故事变为"使用启动命令初始化"

### 2. 自适应促进

- 根据用户技能水平（初级/中级/专家）调整对话风格
- 专家获得快速、技术性讨论
- 初学者获得教育和复杂性保护
- 每个人都产生相同的高质量输出

### 3. 动态版本验证

- 从不信任硬编码的版本号
- 使用WebSearch找到当前稳定版本
- 在对话期间验证版本
- 仅记录经过验证的当前版本

### 4. 智能发现

- 没有严格的项目类型模板
- 分析PRD以确定哪些决策对THIS项目重要
- 使用决策和模式的知识库
- 扩展到无限项目类型

### 5. 协作决策制定

- 为每个关键决策促进讨论
- 呈现带有权衡的选项
- 为创新方法整合高级启发
- 确保决策是内聚和兼容的

### 6. 一致输出

- 对话期间结构化决策收集
- 从收集的决策严格生成文档
- 根据硬要求进行验证
- 为AI代理消费进行优化

---

## 工作流结构

```
步骤0：验证工作流并提取项目配置
步骤0.5：验证工作流排序
步骤1：加载PRD并理解项目上下文
步骤2：发现和评估启动模板 ⭐ 新增
步骤3：调整促进风格并识别剩余决策
步骤4：促进协作决策制定（带版本验证）
步骤5：解决横切关注点
步骤6：定义项目结构和边界
步骤7：设计新颖架构模式（需要时）⭐ 新增
步骤8：定义实施模式以防止代理冲突
步骤9：验证架构内聚性
步骤10：生成决策架构文档（带初始化命令）
步骤11：验证文档完整性
步骤12：最终审查和更新工作流状态
```

---

## 此工作流中的文件

- **workflow.yaml** - 配置和元数据
- **instructions.md** - 自适应促进流程
- **decision-catalog.yaml** - 所有架构决策的知识库
- **architecture-patterns.yaml** - 从需求中识别的常见模式
- **pattern-categories.csv** - 教导LLM需要定义的模式原则
- **checklist.md** - 输出文档的验证要求
- **architecture-template.md** - 最终文档的严格格式

---

## 与旧架构的不同

| 方面               | 旧工作流                                 | 新工作流                                    |
| -------------------- | -------------------------------------------- | ----------------------------------------------- |
| **方法**         | 模板驱动                              | 对话驱动                             |
| **项目类型**    | 11种 rigid 类型，22+文件                | 无限灵活性与智能发现 |
| **用户交互** | 带有"继续？"的输出部分             | 协作决策促进             |
| **技能适应**    | 一刀切适用                            | 适应初级/中级/专家          |
| **决策制定**  | 流程后期（步骤5）                     | 前期和中心焦点                       |
| **输出**           | 包括伪造技术规范的多个文档         | 单个决策聚焦架构            |
| **时间**             | 令人困惑和缓慢                           | 根据技能水平30-90分钟          |
| **启发**      | 从未使用                                   | 在决策点整合                   |

---

## 预期输入

- **PRD**（产品需求文档）包含：
  - 功能需求
  - 非功能需求
  - 性能和合规需求

- **Epics**文件包含：
  - 用户故事
  - 验收标准
  - 依赖关系

- **UX规范**（可选但有价值）包含：
  - 界面设计和交互模式
  - 可访问性要求（WCAG级别）
  - 动画和过渡需求
  - 平台特定UI需求
  - 交互的性能期望

---

## 输出文档

单个`architecture.md`文件包含：

- 执行摘要（2-3个句子）
- 项目初始化命令（如果使用启动模板）
- 带有验证版本和史诗映射的决策摘要表
- 完整的项目结构
- 集成规范
- AI代理的一致性规则

---

## 新颖模式设计如何工作

步骤7处理需要被发明的独特或复杂模式：

### 1. 检测

工作流分析PRD中没有标准解决方案的概念：

- 新颖交互模式（例如，在Tinder不存在时"滑动匹配"）
- 复杂的多史诗工作流（例如，"病毒邀请系统"）
- 独特的数据关系（例如，在Facebook之前的"社交图"）
- 新范式（例如，在Snapchat之前的"临时消息"）

### 2. 设计协作

不仅仅是选择技术，工作流帮助设计解决方案：

- 识别要解决的核心问题
- 与用户探索不同的方法
- 记录组件如何交互
- 为复杂流程创建序列图
- 使用启发找到创新解决方案

### 3. 文档化

新颖模式成为架构的一部分，包含：

- 模式名称和目的
- 组件交互
- 数据流图
- 受影响的史诗/故事
- 代理的实施指导

### 4. 示例

```
PRD："用户可以创建带有重叠成员的'圈子'朋友圈"
↓
工作流检测：这是一种新颖的社交结构模式
↓
与用户设计：圈子成员模型、权限级联、UI模式
↓
文档化："圈子模式"以及组件设计和数据流
↓
所有代理都知道如何一致地实施圈子相关功能
```

---

## 实施模式如何工作

步骤8通过定义一致性模式来防止代理冲突：

### 1. 核心原则

> "任何时候多个代理可能对相同的决策做出不同的决定，那是一个需要捕获的模式"

LLM询问："代理可能遇到什么让他们不得不猜测？"

### 2. 模式类别（原则，不是规定）

- **命名**：事物如何命名（API、数据库字段、文件）
- **结构**：事物如何组织（文件夹、模块、层）
- **格式**：数据如何格式化（JSON结构、响应）
- **通信**：组件如何交流（事件、消息、协议）
- **生命周期**：状态如何改变（工作流、转换）
- **位置**：事物去向（URL、路径、存储）
- **一致性**：横切关注点（日期、错误、日志）

### 3. LLM智能

- 使用原则识别7个类别之外的模式
- 弄清楚对所选技术重要的特定模式
- 仅询问可能导致冲突的模式
- 跳过技术选择确定的明显模式

### 4. 示例

```
技术选择：REST API + PostgreSQL + React
↓

LLM识别需要：
- REST：URL结构、响应格式、状态码
- PostgreSQL：表命名、列命名、FK模式
- React：组件结构、状态管理、测试位置
↓

与用户促进每个
↓

在架构中记录为实施模式
```

---

## 启动模板如何工作

当工作流检测到具有启动模板的项目类型时：

1. **发现**：基于PRD搜索相关启动模板
2. **调查**：查找当前CLI选项和默认值
3. **呈现**：向用户展示启动器提供的内容
4. **集成**：将启动器决策记录为"启动器提供"
5. **继续**：仅询问启动器未做出的决策
6. **文档**：在架构中包含确切的初始化命令

### 示例流程

```
PRD说："带有身份验证的Next.js Web应用程序"
↓

工作流发现：create-next-app和create-t3-app
↓

用户选择：create-t3-app（包含身份验证设置）
↓

启动器提供：Next.js、TypeScript、tRPC、Prisma、NextAuth、Tailwind
↓

工作流仅询问：数据库选择、部署目标、附加服务
↓

第一个故事变为："npx create t3-app@latest my-app --trpc --nextauth --prisma"
```

---

## 使用方法

```bash
# 在您的BMAD启用项目中
workflow architecture
```

AI代理将：

1. 加载您的PRD和史诗
2. 识别需要的关键决策
3. 促进每个决策的讨论
4. 生成综合架构文档
5. 验证完整性

---

## 设计原则

1. **促进而非规定** - 指导用户做出良好决策而不是强加模板
2. **智能而非模板** - 使用AI理解而不是刚性结构
3. **决策而非细节** - 专注于防止代理冲突，而不是实施细节
4. **适应而非统一** - 在确保质量输出的同时满足用户需求
5. **协作而非输出** - 对话与文档同样重要

---

## 对于开发人员

此工作流假设：

- 单个开发人员 + AI代理（不是团队）
- 速度很重要（分钟级决策，不是天级）
- AI代理需要明确约束以防止冲突
- 架构文档是为代理，不是人类

---

## 从架构迁移

使用旧`architecture`工作流的项目应该：

1. 完成任何进行中的架构工作
2. 对新项目使用`architecture`
3. 旧工作流仍然可用但已弃用

---

## 版本历史

**1.3.2** - UX规范集成和模糊文件匹配

- 添加UX规范作为可选输入，带模糊文件匹配
- 使用输入文件引用更新workflow.yaml
- 启动模板选择现在考虑UX需求
- 向检查列表添加UX对齐验证
- 指令使用变量引用实现灵活的文件名

**1.3.1** - 工作流细化和标准化

- 在开始处添加工作流状态检查（步骤0和0.5）
- 在结束时添加工作流状态更新（步骤12）
- 为清晰重新组织步骤编号（移除小数步骤）
- 在整个工作流组件中增强基于意图的方法
- 改进所有工作流组件的内聚性

**1.3.0** - 独特模式设计用于独特架构

- 添加新颖模式设计（现在步骤7，前步骤5.3）
- 检测PRD中需要架构发明的概念
- 促进序列图的设计协作
- 为创新方法使用启发
- 为多史诗一致性记录自定义模式

**1.2.0** - 代理一致性的实施模式

- 添加实施模式（现在步骤8，前步骤5.5）
- 创建基于原则的pattern-categories.csv（7个原则，不是118个规定）
- 核心原则："代理可能以不同方式决定什么？"
- LLM使用原则识别类别之外的模式
- 通过智能模式发现防止代理冲突

**1.1.0** - 增强启动模板发现和版本验证

- 添加智能启动模板检测和集成（现在步骤2）
- 通过web搜索添加动态版本验证
- 启动决策记录为"启动器提供"
- 第一个实施故事使用启动初始化命令

**1.0.0** - 初始版本替换架构工作流

---

**相关文档：**

- [解决方案设计工作流](./workflows-solutioning_zh.md)
- [规划工作流](./workflows-planning_zh.md)
- [规模自适应系统](./scale-adaptive-system_zh.md)