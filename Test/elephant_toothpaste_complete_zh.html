<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è±¡ç‰™è†åŒ–å­¦å®éªŒ 3D æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            z-index: 1000;
            min-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #controls h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            text-align: center;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
            font-weight: 500;
        }

        .control-group button {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .control-group button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-group button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .control-group button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-group button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .control-group button.danger:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .control-group input[type="range"] {
            width: 100%;
            margin: 10px 0;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        #info h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        #info p {
            margin: 10px 0;
            color: #34495e;
            font-size: 13px;
            line-height: 1.6;
        }

        #info .formula {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        #status.active {
            background: rgba(39, 174, 96, 0.9);
        }

        #status.warning {
            background: rgba(230, 126, 34, 0.9);
        }

        #status.error {
            background: rgba(231, 76, 60, 0.9);
        }

        #startButton {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 18px 45px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #startButton:hover:not(:disabled) {
            transform: translateX(-50%) translateY(-4px);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.4);
        }

        #startButton:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: translateX(-50%);
            box-shadow: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 22px;
            z-index: 2000;
            text-align: center;
            background: rgba(44, 62, 80, 0.9);
            padding: 40px 60px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 25px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats div {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .stats span {
            color: #3498db;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            #controls {
                transform: scale(0.85);
                transform-origin: top left;
            }

            #info {
                transform: scale(0.85);
                transform-origin: bottom left;
            }

            .stats {
                transform: scale(0.85);
                transform-origin: top right;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">
            <div class="loading-spinner"></div>
            <h2>æ­£åœ¨åŠ è½½ 3D åœºæ™¯...</h2>
            <p>è¯·ç¨å€™ï¼Œæ­£åœ¨å‡†å¤‡å¤§è±¡ç‰™è†å®éªŒ</p>
        </div>

        <div id="controls">
            <h2>ğŸ§ª å®éªŒæ§åˆ¶é¢æ¿</h2>

            <div class="control-group">
                <button id="resetExperiment">ğŸ”„ é‡ç½®å®éªŒ</button>
                <button id="toggleParticles">âœ¨ åˆ‡æ¢ç²’å­æ•ˆæœ</button>
                <button id="toggleShadows">ğŸŒ‘ åˆ‡æ¢é˜´å½±æ•ˆæœ</button>
            </div>

            <div class="control-group">
                <label for="reactionSpeed">âš¡ ååº”é€Ÿåº¦: <span id="speedValue">1.0</span>x</label>
                <input type="range" id="reactionSpeed" min="0.5" max="3.0" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <label for="foamIntensity">ğŸ’¨ æ³¡æ²«å¼ºåº¦: <span id="intensityValue">100</span>%</label>
                <input type="range" id="foamIntensity" min="50" max="200" step="10" value="100">
            </div>

            <div class="control-group">
                <label for="foamColor">ğŸ¨ æ³¡æ²«é¢œè‰²:</label>
                <select id="foamColor">
                    <option value="fluorescentPink">è§å…‰ç²‰</option>
                    <option value="yellow">æŸ æª¬é»„</option>
                    <option value="orange">æ©˜å­æ©™</option>
                    <option value="green">è–„è·ç»¿</option>
                    <option value="blue">å¤©ç©ºè“</option>
                </select>
            </div>

            <div class="control-group">
                <button id="toggleCamera">ğŸ“· åˆ‡æ¢ç›¸æœºè§’åº¦</button>
                <button id="autoRotate">ğŸ”„ è‡ªåŠ¨æ—‹è½¬</button>
            </div>
        </div>

        <div id="info">
            <h3>ğŸ˜ å¤§è±¡ç‰™è†å®éªŒ</h3>
            <p><strong>åŒ–å­¦ååº”:</strong></p>
            <div class="formula">2Hâ‚‚Oâ‚‚ â†’ 2Hâ‚‚O + Oâ‚‚â†‘</div>
            <p><strong>å‚¬åŒ–å‰‚:</strong> ç¢˜åŒ–é’¾ (KI) æº¶æ¶²</p>
            <p><strong>ç°è±¡:</strong> è¿‡æ°§åŒ–æ°¢å¿«é€Ÿåˆ†è§£äº§ç”Ÿå¤§é‡æ°§æ°”æ³¡æ²«ï¼Œå¦‚åŒå¤§è±¡ç‰™è†æŒ¤å‡º</p>
            <p><strong>åŸç†:</strong> å‚¬åŒ–å‰‚åŠ é€Ÿååº”ï¼Œäº§ç”Ÿå¯†é›†æ³¡æ²«æŸ±</p>
        </div>

        <div id="status">å‡†å¤‡å°±ç»ª</div>
        <button id="startButton">ğŸš€ å¼€å§‹å–·å‘</button>

        <div class="stats" id="stats" style="display: none;">
            <div>FPS: <span id="fps">60</span></div>
            <div>ç²’å­æ•°: <span id="particleCount">0</span></div>
            <div>æ¨¡æ‹Ÿæ—¶é—´: <span id="simTime">0.0</span>s</div>
            <div>æ¶²ä½é«˜åº¦: <span id="liquidLevel">33</span>%</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer;
        let erlenmeyerFlask, liquid, foamSystem;
        let experimentRunning = false;
        let simulationTime = 0;
        let liquidLevel = 0.33;
        let autoRotate = false;
        let shadowsEnabled = true;
        let particlesEnabled = true;

        // å®éªŒå‚æ•°
        let config = {
            reactionSpeed: 1.0,
            foamIntensity: 1.0,
            foamColor: 'fluorescentPink',
            cameraAngle: 'diagonal'
        };

        // é¢œè‰²é…ç½®
        const colorSchemes = {
            fluorescentPink: {
                liquid: 0xff1493,
                foam: 0xff69b4,
                foamVariation: [0xff1493, 0xff69b4, 0xffb6c1, 0xff69b4]
            },
            yellow: {
                liquid: 0xffd700,
                foam: 0xffeb3b,
                foamVariation: [0xffd700, 0xffeb3b, 0xfff59d, 0xffff00]
            },
            orange: {
                liquid: 0xff8c00,
                foam: 0xff9800,
                foamVariation: [0xff8c00, 0xff9800, 0xffb74d, 0xffa500]
            },
            green: {
                liquid: 0x32cd32,
                foam: 0x90ee90,
                foamVariation: [0x32cd32, 0x90ee90, 0x98fb98, 0x00ff00]
            },
            blue: {
                liquid: 0x1e90ff,
                foam: 0x87ceeb,
                foamVariation: [0x1e90ff, 0x87ceeb, 0x87cefa, 0x00bfff]
            }
        };

        // æ³¡æ²«ç²’å­ç±»
        class FoamParticle {
            constructor(position, velocity) {
                this.position = position.clone();
                this.velocity = velocity.clone();
                this.acceleration = new THREE.Vector3();
                this.size = Math.random() * 0.8 + 0.4;
                this.mass = this.size * 0.1;
                this.life = 1.0;
                this.maxLife = 1.0;
                this.isSettled = false;
                this.settleTime = 0;
                this.color = this.getRandomColor();
                this.originalSize = this.size;
                this.rotation = new THREE.Vector3(
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2
                );
                this.rotationSpeed = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1,
                    (Math.random() - 0.5) * 0.1
                );

                // å˜å½¢å‚æ•°
                this.deformation = {
                    x: 1, y: 1, z: 1
                };

                // å™ªå£°çº¹ç†å‚æ•°
                this.noiseOffset = Math.random() * Math.PI * 2;
            }

            getRandomColor() {
                const colors = colorSchemes[config.foamColor].foamVariation;
                const baseColor = colors[Math.floor(Math.random() * colors.length)];
                const color = new THREE.Color(baseColor);

                // æ·»åŠ äº®åº¦å˜åŒ–
                const brightness = 0.7 + Math.random() * 0.3;
                color.r *= brightness;
                color.g *= brightness;
                color.b *= brightness;

                return color;
            }

            update(deltaTime, particles, groundLevel = 0) {
                if (this.isSettled) {
                    this.settleTime += deltaTime;
                    // æ²‰é™åçš„æ‰©æ•£æ•ˆæœ
                    if (this.settleTime < 0.8) {
                        const settleProgress = this.settleTime / 0.8;
                        this.deformation.x = 1 + settleProgress * 0.6;
                        this.deformation.z = 1 + settleProgress * 0.6;
                        this.deformation.y = Math.max(0.2, 1 - settleProgress * 0.8);
                    }

                    // æ—‹è½¬å‡ç¼“
                    this.rotationSpeed.multiplyScalar(0.95);
                    return;
                }

                // åº”ç”¨é‡åŠ›
                this.acceleration.y = -9.8 * this.mass * 0.1;

                // æ³¡æ²«é—´çš„æ’æ–¥åŠ›ï¼ˆæµä½“åŠ¨åŠ›å­¦æ•ˆæœï¼‰
                particles.forEach(other => {
                    if (other !== this && !other.isSettled) {
                        const distance = this.position.distanceTo(other.position);
                        const minDistance = (this.size + other.size) * 1.5;

                        if (distance < minDistance && distance > 0) {
                            const force = new THREE.Vector3()
                                .subVectors(this.position, other.position)
                                .normalize()
                                .multiplyScalar((minDistance - distance) * 0.8);
                            this.acceleration.add(force.divideByScalar(this.mass));
                        }
                    }
                });

                // æ¹æµæ•ˆæœ
                const time = simulationTime + this.noiseOffset;
                const turbulence = new THREE.Vector3(
                    Math.sin(time * 2) * 0.15,
                    Math.cos(time * 1.5) * 0.08,
                    Math.sin(time * 2.5) * 0.15
                );
                this.acceleration.add(turbulence);

                // æ›´æ–°é€Ÿåº¦å’Œä½ç½®
                this.velocity.add(this.acceleration.multiplyScalar(deltaTime));

                // ç©ºæ°”é˜»åŠ›
                this.velocity.multiplyScalar(0.98);

                const oldPosition = this.position.clone();
                this.position.add(this.velocity.clone().multiplyScalar(deltaTime));

                // åœ°é¢ç¢°æ’æ£€æµ‹
                if (this.position.y <= groundLevel + this.size) {
                    this.position.y = groundLevel + this.size;

                    // å†²å‡»å˜å½¢
                    const impactForce = Math.abs(this.velocity.y);
                    this.deformation.y = Math.max(0.3, 1 - impactForce * 0.15);
                    this.deformation.x = Math.min(1.8, 1 + impactForce * 0.08);
                    this.deformation.z = Math.min(1.8, 1 + impactForce * 0.08);

                    // åå¼¹å’Œæ‘©æ“¦
                    this.velocity.y *= -0.15;
                    this.velocity.x *= 0.4;
                    this.velocity.z *= 0.4;

                    // åœæ­¢æ¡ä»¶
                    if (Math.abs(this.velocity.y) < 0.8) {
                        this.isSettled = true;
                        this.velocity.set(0, 0, 0);
                    }
                }

                // é”¥å½¢ç“¶ç¢°æ’æ£€æµ‹
                const flaskCenter = new THREE.Vector3(0, 10, 0);
                const flaskRadius = 8;
                const distanceToFlask = this.position.distanceTo(flaskCenter);

                if (distanceToFlask < flaskRadius + this.size &&
                    this.position.y > 0 && this.position.y < 20) {
                    const pushDirection = new THREE.Vector3()
                        .subVectors(this.position, flaskCenter)
                        .normalize();
                    this.position = flaskCenter.clone().add(
                        pushDirection.multiplyScalar(flaskRadius + this.size)
                    );

                    // åå¼¹
                    const normal = pushDirection;
                    const dotProduct = this.velocity.dot(normal);
                    this.velocity.sub(normal.multiplyScalar(2 * dotProduct));
                    this.velocity.multiplyScalar(0.7);
                }

                // æ›´æ–°æ—‹è½¬
                this.rotation.x += this.rotationSpeed.x * deltaTime;
                this.rotation.y += this.rotationSpeed.y * deltaTime;
                this.rotation.z += this.rotationSpeed.z * deltaTime;

                // é‡ç½®åŠ é€Ÿåº¦
                this.acceleration.set(0, 0, 0);

                // æ›´æ–°ç”Ÿå‘½å€¼
                this.life -= deltaTime * 0.05;
                this.size = this.originalSize * Math.min(1, this.life);
            }
        }

        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            createScene();
            createLights();
            createGround();
            createErlenmeyerFlask();
            createFoamSystem();
            setupEventListeners();
            animate();

            // éšè—åŠ è½½ç•Œé¢
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 2000);
        }

        function createScene() {
            // åœºæ™¯è®¾ç½®
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            scene.fog = new THREE.Fog(0xf0f0f0, 100, 1000);

            // ç›¸æœºè®¾ç½® - 45åº¦å¯¹è§’ä¿¯è§†è§’åº¦
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 2000);

            // è®¾ç½®ç›¸æœºä½ç½®
            updateCameraPosition();

            // æ¸²æŸ“å™¨è®¾ç½®
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.physicallyCorrectLights = true;
            document.getElementById('container').appendChild(renderer.domElement);
        }

        function updateCameraPosition() {
            const distance = 60;

            switch (config.cameraAngle) {
                case 'diagonal':
                    // 45åº¦å¯¹è§’ä¿¯è§†
                    camera.position.set(
                        distance * Math.cos(Math.PI / 4) * 0.7,
                        distance * Math.sin(Math.PI / 4),
                        distance * Math.cos(Math.PI / 4) * 0.7
                    );
                    break;
                case 'side':
                    camera.position.set(distance, 25, 0);
                    break;
                case 'top':
                    camera.position.set(0, distance * 1.5, distance * 0.5);
                    break;
                case 'close':
                    camera.position.set(30, 20, 30);
                    break;
            }

            camera.lookAt(0, 10, 0);
        }

        function createLights() {
            // ä¸»å®šå‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(50, 80, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 200;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            directionalLight.shadow.bias = -0.0001;
            directionalLight.shadow.normalBias = 0.02;
            scene.add(directionalLight);

            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            // é¢å¤–çš„ç‚¹å…‰æº
            const pointLight1 = new THREE.PointLight(0xffffff, 0.8, 100);
            pointLight1.position.set(-30, 40, -30);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xffffff, 0.8, 100);
            pointLight2.position.set(30, 40, 30);
            scene.add(pointLight2);
        }

        function createGround() {
            // ä¸»åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0xcccccc,
                roughness: 0.8,
                metalness: 0.1
            });

            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // ç½‘æ ¼è¾…åŠ©
            const gridHelper = new THREE.GridHelper(1000, 100, 0x888888, 0xdddddd);
            scene.add(gridHelper);
        }

        function createErlenmeyerFlask() {
            const flaskGroup = new THREE.Group();

            // ç»ç’ƒæè´¨ - æŒ‰éœ€æ±‚æ–‡æ¡£ç²¾ç¡®è®¾ç½®
            const glassMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.9,
                roughness: 0.05,
                metalness: 0.35,
                clearcoat: 1.0,
                clearcoatRoughness: 0.03,
                transmission: 0.95,
                ior: 1.5,
                side: THREE.DoubleSide,
                envMapIntensity: 1.5,
                reflectivity: 0.9
            });

            // åˆ›å»ºé”¥å½¢ç“¶å½¢çŠ¶
            const flaskGeometry = createErlenmeyerGeometry();
            const flask = new THREE.Mesh(flaskGeometry, glassMaterial);
            flask.castShadow = true;
            flask.receiveShadow = true;
            flaskGroup.add(flask);

            // åˆ›å»ºæ¶²ä½“
            createLiquid(flaskGroup);

            // å®šä½é”¥å½¢ç“¶
            flaskGroup.position.set(0, 0, 0);
            erlenmeyerFlask = flaskGroup;
            scene.add(erlenmeyerFlask);
        }

        function createErlenmeyerGeometry() {
            const shape = new THREE.Shape();
            const height = 20;
            const bottomRadius = 8;
            const topRadius = 2;
            const neckHeight = 4;

            // ç»˜åˆ¶é”¥å½¢ç“¶è½®å»“
            shape.moveTo(0, 0);

            // åº•éƒ¨æ›²çº¿
            shape.quadraticCurveTo(bottomRadius * 0.5, 0, bottomRadius, 0.5);

            // é”¥å½¢ä¸»ä½“
            shape.lineTo(bottomRadius, height - neckHeight);

            // è¿‡æ¸¡åˆ°ç“¶é¢ˆ
            shape.quadraticCurveTo(
                (bottomRadius + topRadius) / 2, height - neckHeight,
                topRadius, height - neckHeight
            );

            // ç“¶é¢ˆ
            shape.lineTo(topRadius, height);

            // åˆ›å»ºæ—‹è½¬å‡ ä½•ä½“
            const geometry = new THREE.LatheGeometry(shape.getPoints(), 64);
            return geometry;
        }

        function createLiquid(flaskGroup) {
            const liquidHeight = 20 * liquidLevel;
            const bottomRadius = 7.5;
            const topRadius = bottomRadius - (bottomRadius - 1.5) * liquidLevel;

            const shape = new THREE.Shape();
            shape.moveTo(0, 0);
            shape.quadraticCurveTo(bottomRadius * 0.5, 0, bottomRadius, 0.2);
            shape.lineTo(topRadius, liquidHeight);
            shape.lineTo(0, liquidHeight);
            shape.lineTo(0, 0);

            const liquidGeometry = new THREE.LatheGeometry(shape.getPoints(), 64);
            const liquidMaterial = new THREE.MeshPhysicalMaterial({
                color: colorSchemes[config.foamColor].liquid,
                transparent: true,
                opacity: 0.8,
                transmission: 0.2,
                roughness: 0.1,
                metalness: 0,
                clearcoat: 0.8,
                clearcoatRoughness: 0.2,
                ior: 1.33
            });

            liquid = new THREE.Mesh(liquidGeometry, liquidMaterial);
            liquid.position.y = 0;
            flaskGroup.add(liquid);
        }

        function createFoamSystem() {
            foamSystem = {
                particles: [],
                particleGeometry: new THREE.SphereGeometry(0.5, 8, 6),
                particleMaterial: new THREE.MeshStandardMaterial({
                    transparent: true,
                    opacity: 0.7,
                    roughness: 0.9,
                    metalness: 0
                }),
                group: new THREE.Group()
            };

            scene.add(foamSystem.group);
        }

        function startEruption() {
            if (experimentRunning) return;

            experimentRunning = true;
            simulationTime = 0;
            updateStatus('å–·å‘è¿›è¡Œä¸­...', 'active');
            document.getElementById('startButton').disabled = true;

            // åˆ›å»ºåˆå§‹æ³¡æ²«çˆ†å‘
            createFoamBurst();

            // æ¶²ä½é€æ¸ä¸‹é™
            const liquidReductionInterval = setInterval(() => {
                if (liquidLevel > 0.05) {
                    liquidLevel -= 0.008 * config.reactionSpeed;
                    updateLiquidLevel();
                    updateLiquidLevelDisplay();
                } else {
                    clearInterval(liquidReductionInterval);
                }
            }, 100);

            // åœæ­¢å–·å‘
            setTimeout(() => {
                stopEruption();
            }, 10000 / config.reactionSpeed);
        }

        function createFoamBurst() {
            const burstCount = 80 * config.foamIntensity;
            const flaskMouth = new THREE.Vector3(0, 20, 0);

            for (let i = 0; i < burstCount; i++) {
                // åˆå§‹ä½ç½®åœ¨ç“¶å£é™„è¿‘
                const position = flaskMouth.clone();
                position.x += (Math.random() - 0.5) * 3;
                position.z += (Math.random() - 0.5) * 3;

                // åˆå§‹é€Ÿåº¦ - å¼ºçƒˆå‘ä¸Šå–·å°„
                const velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 12,
                    25 + Math.random() * 15, // å¼ºå¤§çš„å‘ä¸ŠåŠ›
                    (Math.random() - 0.5) * 12
                );

                const particle = new FoamParticle(position, velocity);
                foamSystem.particles.push(particle);

                // åˆ›å»ºè§†è§‰è¡¨ç°
                const mesh = new THREE.Mesh(
                    foamSystem.particleGeometry,
                    foamSystem.particleMaterial.clone()
                );
                mesh.material.color = particle.color;
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData = { particle: particle };

                foamSystem.group.add(mesh);
            }

            updateParticleCount();
        }

        function updateLiquidLevel() {
            if (!liquid) return;

            // ç§»é™¤æ—§æ¶²ä½“
            erlenmeyerFlask.remove(liquid);

            // åˆ›å»ºæ–°æ¶²ä½“å‡ ä½•ä½“
            const liquidHeight = 20 * liquidLevel;
            const bottomRadius = 7.5;
            const topRadius = bottomRadius - (bottomRadius - 1.5) * liquidLevel;

            const shape = new THREE.Shape();
            shape.moveTo(0, 0);
            shape.quadraticCurveTo(bottomRadius * 0.5, 0, bottomRadius, 0.2);
            shape.lineTo(topRadius, liquidHeight);
            shape.lineTo(0, liquidHeight);
            shape.lineTo(0, 0);

            const liquidGeometry = new THREE.LatheGeometry(shape.getPoints(), 64);
            const liquidMaterial = new THREE.MeshPhysicalMaterial({
                color: colorSchemes[config.foamColor].liquid,
                transparent: true,
                opacity: 0.8,
                transmission: 0.2,
                roughness: 0.1,
                metalness: 0,
                clearcoat: 0.8,
                clearcoatRoughness: 0.2,
                ior: 1.33
            });

            liquid = new THREE.Mesh(liquidGeometry, liquidMaterial);
            liquid.position.y = 0;
            erlenmeyerFlask.add(liquid);
        }

        function updateLiquidLevelDisplay() {
            const percentage = Math.round(liquidLevel * 100);
            document.getElementById('liquidLevel').textContent = percentage;
        }

        function updateFoamParticles(deltaTime) {
            const toRemove = [];

            foamSystem.particles.forEach((particle, index) => {
                particle.update(deltaTime, foamSystem.particles, 0);

                // æ›´æ–°è§†è§‰è¡¨ç°
                const mesh = foamSystem.group.children.find(child =>
                    child.userData.particle === particle
                );

                if (mesh) {
                    mesh.position.copy(particle.position);
                    mesh.rotation.set(particle.rotation.x, particle.rotation.y, particle.rotation.z);
                    mesh.scale.set(
                        particle.size * particle.deformation.x,
                        particle.size * particle.deformation.y,
                        particle.size * particle.deformation.z
                    );
                    mesh.material.opacity = 0.7 * particle.life;
                }

                // ç§»é™¤æ­»äº¡çš„ç²’å­
                if (particle.life <= 0) {
                    toRemove.push(index);
                    if (mesh) {
                        foamSystem.group.remove(mesh);
                    }
                }
            });

            // ç§»é™¤æ­»äº¡ç²’å­
            toRemove.reverse().forEach(index => {
                foamSystem.particles.splice(index, 1);
            });

            // æŒç»­æ·»åŠ æ–°æ³¡æ²«
            if (experimentRunning && Math.random() < 0.4 * config.foamIntensity) {
                const flaskMouth = new THREE.Vector3(0, 20, 0);
                const position = flaskMouth.clone();
                position.x += (Math.random() - 0.5) * 4;
                position.z += (Math.random() - 0.5) * 4;

                const velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 10,
                    18 + Math.random() * 12,
                    (Math.random() - 0.5) * 10
                );

                const particle = new FoamParticle(position, velocity);
                foamSystem.particles.push(particle);

                const mesh = new THREE.Mesh(
                    foamSystem.particleGeometry,
                    foamSystem.particleMaterial.clone()
                );
                mesh.material.color = particle.color;
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData = { particle: particle };

                foamSystem.group.add(mesh);
            }

            updateParticleCount();
        }

        function stopEruption() {
            experimentRunning = false;
            updateStatus('å–·å‘å®Œæˆ', 'warning');
            document.getElementById('startButton').disabled = false;

            setTimeout(() => {
                updateStatus('å‡†å¤‡å°±ç»ª');
            }, 3000);
        }

        function resetExperiment() {
            experimentRunning = false;
            simulationTime = 0;
            liquidLevel = 0.33;

            // æ¸…é™¤æ‰€æœ‰æ³¡æ²«ç²’å­
            foamSystem.particles = [];
            while (foamSystem.group.children.length > 0) {
                foamSystem.group.remove(foamSystem.group.children[0]);
            }

            // é‡ç½®æ¶²ä½
            updateLiquidLevel();
            updateLiquidLevelDisplay();

            updateStatus('å®éªŒå·²é‡ç½®');
            document.getElementById('startButton').disabled = false;
            updateParticleCount();
        }

        function setupEventListeners() {
            document.getElementById('startButton').addEventListener('click', startEruption);
            document.getElementById('resetExperiment').addEventListener('click', resetExperiment);

            document.getElementById('reactionSpeed').addEventListener('input', (e) => {
                config.reactionSpeed = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = e.target.value;
            });

            document.getElementById('foamIntensity').addEventListener('input', (e) => {
                config.foamIntensity = parseInt(e.target.value) / 100;
                document.getElementById('intensityValue').textContent = e.target.value;
            });

            document.getElementById('foamColor').addEventListener('change', (e) => {
                config.foamColor = e.target.value;
                updateColors();
            });

            document.getElementById('toggleParticles').addEventListener('click', () => {
                particlesEnabled = !particlesEnabled;
                foamSystem.group.visible = particlesEnabled;
            });

            document.getElementById('toggleShadows').addEventListener('click', () => {
                shadowsEnabled = !shadowsEnabled;
                renderer.shadowMap.enabled = shadowsEnabled;
                scene.traverse((child) => {
                    if (child instanceof THREE.Mesh) {
                        child.castShadow = shadowsEnabled;
                        child.receiveShadow = shadowsEnabled;
                    }
                });
            });

            document.getElementById('toggleCamera').addEventListener('click', () => {
                const angles = ['diagonal', 'side', 'top', 'close'];
                const currentIndex = angles.indexOf(config.cameraAngle);
                config.cameraAngle = angles[(currentIndex + 1) % angles.length];
                updateCameraPosition();
            });

            document.getElementById('autoRotate').addEventListener('click', () => {
                autoRotate = !autoRotate;
                document.getElementById('autoRotate').textContent =
                    autoRotate ? 'åœæ­¢æ—‹è½¬' : 'è‡ªåŠ¨æ—‹è½¬';
            });

            window.addEventListener('resize', onWindowResize);
        }

        function updateColors() {
            // æ›´æ–°æ¶²ä½“é¢œè‰²
            if (liquid && liquid.material) {
                liquid.material.color.setHex(colorSchemes[config.foamColor].liquid);
            }

            // æ›´æ–°ç°æœ‰æ³¡æ²«ç²’å­é¢œè‰²
            foamSystem.particles.forEach(particle => {
                particle.color = particle.getRandomColor();
                const mesh = foamSystem.group.children.find(child =>
                    child.userData.particle === particle
                );
                if (mesh) {
                    mesh.material.color = particle.color;
                }
            });
        }

        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }

        function updateParticleCount() {
            document.getElementById('particleCount').textContent = foamSystem.particles.length;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // æ€§èƒ½ç›‘æ§
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 60;

        function updateStats() {
            frameCount++;
            const currentTime = performance.now();

            if (currentTime >= lastTime + 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;

                document.getElementById('fps').textContent = fps;
                document.getElementById('simTime').textContent = simulationTime.toFixed(1);
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;

            // æ›´æ–°æ¨¡æ‹Ÿæ—¶é—´
            if (experimentRunning) {
                simulationTime += deltaTime * config.reactionSpeed;
            }

            // æ›´æ–°æ³¡æ²«ç²’å­
            if (particlesEnabled) {
                updateFoamParticles(deltaTime);
            }

            // è‡ªåŠ¨æ—‹è½¬
            if (autoRotate && !experimentRunning) {
                const rotationSpeed = 0.005;
                erlenmeyerFlask.rotation.y += rotationSpeed;
            }

            // æ›´æ–°ç»Ÿè®¡
            updateStats();

            // æ¸²æŸ“
            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        setTimeout(() => {
            document.getElementById('stats').style.display = 'block';
        }, 2500);
    </script>
</body>
</html>