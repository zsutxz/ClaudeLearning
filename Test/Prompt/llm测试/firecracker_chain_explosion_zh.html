<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­ç‚®è¿é”çˆ†ç‚¸ 3D æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            z-index: 1000;
            min-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #controls h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 12px;
            text-align: center;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
            font-weight: 500;
        }

        .control-group button {
            width: 100%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .control-group button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .control-group button:active:not(:disabled) {
            transform: translateY(-1px);
        }

        .control-group button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-group button.secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .control-group button.secondary:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .control-group button.danger {
            background: linear-gradient(135deg, #e67e22, #d35400);
            box-shadow: 0 6px 20px rgba(230, 126, 34, 0.3);
        }

        .control-group button.danger:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(230, 126, 34, 0.4);
        }

        .control-group input[type="range"] {
            width: 100%;
            margin: 10px 0;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
            transition: all 0.3s ease;
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            z-index: 1000;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        #info h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }

        #info p {
            margin: 10px 0;
            color: #34495e;
            font-size: 13px;
            line-height: 1.6;
        }

        #info .warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
            font-size: 12px;
            color: #856404;
        }

        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        #status.active {
            background: rgba(231, 76, 60, 0.9);
        }

        #status.warning {
            background: rgba(243, 156, 18, 0.9);
        }

        #status.success {
            background: rgba(39, 174, 96, 0.9);
        }

        #startButton {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 18px 45px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #startButton:hover:not(:disabled) {
            transform: translateX(-50%) translateY(-4px);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.4);
        }

        #startButton:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: translateX(-50%);
            box-shadow: none;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 22px;
            z-index: 2000;
            text-align: center;
            background: rgba(44, 62, 80, 0.9);
            padding: 40px 60px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 25px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .stats div {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats span {
            color: #e74c3c;
            font-weight: bold;
        }

        .stats .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .stats .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.3s ease;
        }

        .mode-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .mode-indicator.active {
            display: block;
        }

        @media (max-width: 768px) {
            #controls {
                transform: scale(0.85);
                transform-origin: top left;
            }

            #info {
                transform: scale(0.85);
                transform-origin: bottom left;
            }

            .stats {
                transform: scale(0.85);
                transform-origin: top right;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">
            <div class="loading-spinner"></div>
            <h2>æ­£åœ¨åŠ è½½ 3D åœºæ™¯...</h2>
            <p>è¯·ç¨å€™ï¼Œæ­£åœ¨å‡†å¤‡é­ç‚®è¿é”çˆ†ç‚¸æ¼”ç¤º</p>
        </div>

        <div id="controls">
            <h2>ğŸ† é­ç‚®æ§åˆ¶é¢æ¿</h2>

            <div class="control-group">
                <button id="startFireworks">ğŸš€ å¼€å§‹ç‡ƒæ”¾</button>
                <button id="resetScene" class="secondary">ğŸ”„ é‡ç½®åœºæ™¯</button>
                <button id="singleDetonation" class="danger">ğŸ’¥ å•ä¸ªå¼•çˆ†æ¨¡å¼</button>
            </div>

            <div class="control-group">
                <label for="explosionPower">ğŸ’¥ çˆ†ç‚¸å¨åŠ›: <span id="powerValue">100</span>%</label>
                <input type="range" id="explosionPower" min="50" max="150" step="10" value="100">
            </div>

            <div class="control-group">
                <label for="chainDelay">â±ï¸ è¿é”å»¶è¿Ÿ: <span id="delayValue">200</span>ms</label>
                <input type="range" id="chainDelay" min="100" max="500" step="50" value="200">
            </div>

            <div class="control-group">
                <label for="particleCount">âœ¨ ç²’å­æ•°é‡: <span id="particleValue">65</span></label>
                <input type="range" id="particleCount" min="30" max="100" step="5" value="65">
            </div>

            <div class="control-group">
                <button id="toggleEffects" class="secondary">ğŸ¨ åˆ‡æ¢ç‰¹æ•ˆ</button>
                <button id="toggleSound" class="secondary">ğŸ”Š éŸ³æ•ˆå¼€å…³</button>
                <button id="toggleCamera" class="secondary">ğŸ“· åˆ‡æ¢è§†è§’</button>
            </div>
        </div>

        <div id="info">
            <h3>ğŸ¯ é­ç‚®è¿é”çˆ†ç‚¸</h3>
            <p><strong>æ¼”ç¤ºè¯´æ˜:</strong> è§‚é€¼çœŸçš„é­ç‚®è¿é”çˆ†ç‚¸æ•ˆæœï¼ŒåŒ…å«å®Œæ•´çš„ç‰©ç†æ¨¡æ‹Ÿå’Œè§†è§‰ç‰¹æ•ˆã€‚</p>
            <p><strong>ä¸»è¦ç‰¹æ€§:</strong></p>
            <ul style="margin-left: 20px; color: #34495e; font-size: 13px;">
                <li>çœŸå®çš„è¿é”ååº”æœºåˆ¶</li>
                <li>çˆ†ç‚¸å†²å‡»æ³¢å’Œå¼¹å°„æ•ˆæœ</li>
                <li>ç«èŠ±ã€çƒŸé›¾ç­‰ç²’å­ç‰¹æ•ˆ</li>
                <li>åŠ¨æ€å…‰ç…§å’Œé˜´å½±æ•ˆæœ</li>
            </ul>
            <div class="warning">
                <strong>âš ï¸ å®‰å…¨æç¤º:</strong> è¿™æ˜¯è®¡ç®—æœºæ¨¡æ‹Ÿæ¼”ç¤ºï¼Œè¯·å‹¿æ¨¡ä»¿çœŸå®é­ç‚®æ“ä½œï¼
            </div>
        </div>

        <div class="mode-indicator" id="modeIndicator">
            ğŸ¯ å•ä¸ªå¼•çˆ†æ¨¡å¼ - ç‚¹å‡»é­ç‚®è¿›è¡Œå¼•çˆ†
        </div>

        <div id="status">å‡†å¤‡å°±ç»ª</div>
        <button id="startButton">ğŸ† å¼€å§‹ç‡ƒæ”¾</button>

        <div class="stats" id="stats" style="display: none;">
            <div>å‰©ä½™é­ç‚®: <span id="remainingFirecrackers">0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div>å·²çˆ†ç‚¸: <span id="explodedCount">0</span></div>
            <div>è¿é”ååº”: <span id="chainActive">å¦</span></div>
            <div>æ´»è·ƒç²’å­: <span id="activeParticles">0</span></div>
            <div>FPS: <span id="fps">60</span></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer;
        let ground, glassBox;
        let firecrackers = [];
        let explosionSystem, chainReactionManager;
        let raycaster, mouse;
        let isAnimating = false;
        let singleDetonationMode = false;
        let effectsEnabled = true;
        let soundEnabled = false;

        // å®éªŒå‚æ•°
        let config = {
            explosionPower: 1.0,
            chainDelay: 200,
            particleCount: 65,
            cameraAngle: 'default'
        };

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            totalFirecrackers: 0,
            explodedCount: 0,
            remainingCount: 0,
            activeParticles: 0,
            chainActive: false
        };

        // é­ç‚®ç±»
        class Firecracker {
            constructor(position, id) {
                this.id = id;
                this.position = position.clone();
                this.velocity = new THREE.Vector3();
                this.acceleration = new THREE.Vector3();
                this.rotation = new THREE.Vector3();
                this.rotationVelocity = new THREE.Vector3();

                this.isLit = false;
                this.isExploded = false;
                this.burningTime = 0;
                this.burnDuration = 2000; // 2ç§’ç‡ƒçƒ§æ—¶é—´
                this.igniteTime = 0;

                this.isEjected = false;
                this.hasCollided = false;

                this.group = new THREE.Group();
                this.createModel();
                this.updatePosition();
            }

            createModel() {
                // ä¸»ä½“ - çº¢è‰²åœ†æŸ±ä½“
                const bodyGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1, 16);
                const bodyMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff0000,
                    roughness: 0.6,
                    metalness: 0.2
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.castShadow = true;
                body.receiveShadow = true;

                // é¡¶éƒ¨å°ç›– - åœŸé»„è‰²åœ†æŸ±ä½“
                const topCapGeometry = new THREE.CylinderGeometry(0.12, 0.1, 0.05, 16);
                const capMaterial = new THREE.MeshStandardMaterial({
                    color: 0xdaa520,
                    roughness: 0.8
                });
                const topCap = new THREE.Mesh(topCapGeometry, capMaterial);
                topCap.position.y = 0.525;
                topCap.castShadow = true;
                topCap.receiveShadow = true;

                // åº•éƒ¨å°ç›–
                const bottomCap = new THREE.Mesh(topCapGeometry, capMaterial);
                bottomCap.position.y = -0.525;
                bottomCap.castShadow = true;
                bottomCap.receiveShadow = true;

                // å¼•çº¿ - è“ç»¿è‰²ç»†åœ†æŸ±
                const fuseGeometry = new THREE.CylinderGeometry(0.025, 0.025, 0.5, 8);
                const fuseMaterial = new THREE.MeshStandardMaterial({
                    color: 0x20b2aa,
                    roughness: 0.4
                });
                const fuse = new THREE.Mesh(fuseGeometry, fuseMaterial);
                fuse.position.y = 0.775;
                fuse.castShadow = true;

                // å¼•çº¿é¡¶ç«¯ç«æ˜Ÿ - æ©™çº¢è‰²å‘å…‰çƒä½“
                const sparkGeometry = new THREE.SphereGeometry(0.03, 8, 8);
                const sparkMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff4500,
                    emissive: 0xff4500,
                    emissiveIntensity: 0
                });
                this.spark = new THREE.Mesh(sparkGeometry, sparkMaterial);
                this.spark.position.y = 1.05;

                this.group.add(body);
                this.group.add(topCap);
                this.group.add(bottomCap);
                this.group.add(fuse);
                this.group.add(this.spark);

                scene.add(this.group);
            }

            ignite() {
                if (this.isLit || this.isExploded) return;

                this.isLit = true;
                this.igniteTime = Date.now();
                this.spark.material.emissiveIntensity = 1;

                // åˆ›å»ºå¼•ç‡ƒç«èŠ±æ•ˆæœ
                explosionSystem.createIgnitionSparks(this.position.clone().add(new THREE.Vector3(0, 1.05, 0)));
            }

            update(deltaTime) {
                if (this.isExploded) return;

                // ç‡ƒçƒ§é€»è¾‘
                if (this.isLit) {
                    this.burningTime += deltaTime;

                    // æ›´æ–°ç«æ˜Ÿæ•ˆæœ
                    const burnProgress = this.burningTime / this.burnDuration;
                    this.spark.material.emissiveIntensity = 1 - burnProgress * 0.3;

                    // å¼•çº¿ç¼©çŸ­åŠ¨ç”»
                    if (this.burningTime < this.burnDuration) {
                        const fuse = this.group.children[3];
                        const remainingHeight = 0.5 * (1 - burnProgress);
                        fuse.scale.y = remainingHeight / 0.5;
                        fuse.position.y = 0.525 + remainingHeight / 2;
                        this.spark.position.y = fuse.position.y + remainingHeight / 2 + 0.275;
                    }

                    // æ£€æŸ¥æ˜¯å¦è¯¥çˆ†ç‚¸
                    if (this.burningTime >= this.burnDuration) {
                        this.explode();
                        return;
                    }
                }

                // ç‰©ç†æ›´æ–°ï¼ˆä»…åœ¨å¼¹å°„æ—¶ï¼‰
                if (this.isEjected) {
                    // åº”ç”¨é‡åŠ›
                    this.acceleration.y = -9.8;

                    // æ›´æ–°é€Ÿåº¦å’Œä½ç½®
                    this.velocity.add(this.acceleration.clone().multiplyScalar(deltaTime));
                    this.position.add(this.velocity.clone().multiplyScalar(deltaTime));

                    // æ›´æ–°æ—‹è½¬
                    this.rotation.add(this.rotationVelocity.clone().multiplyScalar(deltaTime));

                    // ç¢°æ’æ£€æµ‹
                    this.checkCollisions();

                    // é‡ç½®åŠ é€Ÿåº¦
                    this.acceleration.set(0, 0, 0);

                    this.updatePosition();
                }
            }

            checkCollisions() {
                // åœ°é¢ç¢°æ’
                if (this.position.y <= 0.5) {
                    this.position.y = 0.5;
                    this.velocity.y *= -0.3; // åå¼¹
                    this.velocity.x *= 0.7; // æ‘©æ“¦
                    this.velocity.z *= 0.7;
                    this.rotationVelocity.multiplyScalar(0.8);

                    if (!this.hasCollided) {
                        this.hasCollided = true;
                        explosionSystem.createImpactEffect(this.position);
                    }
                }

                // ç®±å­ç¢°æ’æ£€æµ‹
                const boxBounds = {
                    minX: -5, maxX: 5,
                    minZ: -5, maxZ: 5,
                    maxY: 8
                };

                // ç®€å•çš„è¾¹ç•Œç¢°æ’
                if (Math.abs(this.position.x) > boxBounds.maxX) {
                    this.position.x = Math.sign(this.position.x) * boxBounds.maxX;
                    this.velocity.x *= -0.5;
                }
                if (Math.abs(this.position.z) > boxBounds.maxZ) {
                    this.position.z = Math.sign(this.position.z) * boxBounds.maxZ;
                    this.velocity.z *= -0.5;
                }
            }

            explode() {
                this.isExploded = true;
                stats.explodedCount++;
                stats.remainingCount--;
                updateStats();

                // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
                explosionSystem.createExplosion(this.position);

                // ç§»é™¤é­ç‚®æ¨¡å‹
                scene.remove(this.group);

                // è§¦å‘è¿é”ååº”
                chainReactionManager.triggerChainReaction(this.position, this.id);

                // å±å¹•é—ªç™½æ•ˆæœ
                if (effectsEnabled) {
                    explosionSystem.createScreenFlash();
                }
            }

            eject(force, direction) {
                this.isEjected = true;
                this.velocity = direction.clone().multiplyScalar(force);
                this.rotationVelocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                );
            }

            updatePosition() {
                this.group.position.copy(this.position);
                this.group.rotation.x = this.rotation.x;
                this.group.rotation.y = this.rotation.y;
                this.group.rotation.z = this.rotation.z;
            }

            dispose() {
                if (this.group.parent) {
                    scene.remove(this.group);
                }
            }
        }

        // çˆ†ç‚¸ç³»ç»Ÿç±»
        class ExplosionSystem {
            constructor() {
                this.particles = [];
                this.shockwaves = [];
                this.lights = [];
                this.sparks = [];
                this.smoke = [];
            }

            createExplosion(position) {
                // åˆ›å»ºçº¸å±‘ç¢ç‰‡
                const fragmentCount = config.particleCount;
                for (let i = 0; i < fragmentCount; i++) {
                    this.createFragment(position);
                }

                // åˆ›å»ºå†²å‡»æ³¢
                this.createShockwave(position);

                // åˆ›å»ºåŠ¨æ€å…‰æº
                this.createExplosionLight(position);

                // åˆ›å»ºç«èŠ±
                this.createSparks(position);

                // åˆ›å»ºçƒŸé›¾
                this.createSmoke(position);

                stats.activeParticles += fragmentCount + 20 + 30; // ç¢ç‰‡ + ç«èŠ± + çƒŸé›¾
            }

            createFragment(position) {
                const geometry = new THREE.BoxGeometry(
                    Math.random() * 0.1 + 0.05,
                    Math.random() * 0.05 + 0.02,
                    Math.random() * 0.1 + 0.05
                );

                const material = new THREE.MeshStandardMaterial({
                    color: new THREE.Color().setHSL(0, 0.8, 0.5 + Math.random() * 0.3),
                    roughness: 0.8,
                    metalness: 0.1
                });

                const fragment = new THREE.Mesh(geometry, material);
                fragment.position.copy(position);
                fragment.castShadow = true;
                fragment.receiveShadow = true;

                // éšæœºåˆé€Ÿåº¦
                const speed = Math.random() * 15 + 5;
                const direction = new THREE.Vector3(
                    (Math.random() - 0.5) * 2,
                    Math.random() * 1.5,
                    (Math.random() - 0.5) * 2
                ).normalize();

                fragment.userData = {
                    velocity: direction.multiplyScalar(speed * config.explosionPower),
                    rotationSpeed: new THREE.Vector3(
                        (Math.random() - 0.5) * 20,
                        (Math.random() - 0.5) * 20,
                        (Math.random() - 0.5) * 20
                    ),
                    life: 1.0,
                    gravity: -9.8
                };

                this.particles.push(fragment);
                scene.add(fragment);
            }

            createShockwave(position) {
                const geometry = new THREE.SphereGeometry(0.1, 16, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });

                const shockwave = new THREE.Mesh(geometry, material);
                shockwave.position.copy(position);
                shockwave.userData = {
                    scale: 0.1,
                    maxScale: 6,
                    growthSpeed: 15,
                    opacity: 0.6
                };

                this.shockwaves.push(shockwave);
                scene.add(shockwave);
            }

            createExplosionLight(position) {
                const light = new THREE.PointLight(0xffaa00, 2, 20);
                light.position.copy(position);
                light.userData = {
                    intensity: 2,
                    decaySpeed: 5,
                    life: 0.5
                };

                this.lights.push(light);
                scene.add(light);
            }

            createSparks(position) {
                const sparkCount = 20;
                for (let i = 0; i < sparkCount; i++) {
                    const geometry = new THREE.SphereGeometry(0.02, 4, 4);
                    const material = new THREE.MeshBasicMaterial({
                        color: 0xffaa00,
                        emissive: 0xffaa00,
                        emissiveIntensity: 1
                    });

                    const spark = new THREE.Mesh(geometry, material);
                    spark.position.copy(position);

                    const speed = Math.random() * 20 + 10;
                    const direction = new THREE.Vector3(
                        (Math.random() - 0.5) * 2,
                        Math.random() * 2,
                        (Math.random() - 0.5) * 2
                    ).normalize();

                    spark.userData = {
                        velocity: direction.multiplyScalar(speed),
                        life: 1.0,
                        trail: []
                    };

                    this.sparks.push(spark);
                    scene.add(spark);
                }
            }

            createSmoke(position) {
                const smokeCount = 30;
                for (let i = 0; i < smokeCount; i++) {
                    const geometry = new THREE.SphereGeometry(0.2, 6, 6);
                    const material = new THREE.MeshBasicMaterial({
                        color: 0x888888,
                        transparent: true,
                        opacity: 0.3
                    });

                    const smoke = new THREE.Mesh(geometry, material);
                    smoke.position.copy(position);
                    smoke.position.add(new THREE.Vector3(
                        (Math.random() - 0.5) * 0.5,
                        Math.random() * 0.5,
                        (Math.random() - 0.5) * 0.5
                    ));

                    smoke.userData = {
                        velocity: new THREE.Vector3(
                            (Math.random() - 0.5) * 2,
                            Math.random() * 3 + 1,
                            (Math.random() - 0.5) * 2
                        ),
                        life: 1.0,
                        maxScale: Math.random() * 2 + 1
                    };

                    this.smoke.push(smoke);
                    scene.add(smoke);
                }
            }

            createIgnitionSparks(position) {
                if (!effectsEnabled) return;

                const sparkCount = 10;
                for (let i = 0; i < sparkCount; i++) {
                    const geometry = new THREE.SphereGeometry(0.01, 4, 4);
                    const material = new THREE.MeshBasicMaterial({
                        color: 0xff4500,
                        emissive: 0xff4500
                    });

                    const spark = new THREE.Mesh(geometry, material);
                    spark.position.copy(position);

                    const speed = Math.random() * 5 + 2;
                    const direction = new THREE.Vector3(
                        (Math.random() - 0.5) * 2,
                        Math.random() * 2,
                        (Math.random() - 0.5) * 2
                    ).normalize();

                    spark.userData = {
                        velocity: direction.multiplyScalar(speed),
                        life: 0.5
                    };

                    this.sparks.push(spark);
                    scene.add(spark);
                }
            }

            createImpactEffect(position) {
                // åœ°é¢å†²å‡»æ•ˆæœ
                const geometry = new THREE.RingGeometry(0.1, 0.5, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8,
                    side: THREE.DoubleSide
                });

                const impact = new THREE.Mesh(geometry, material);
                impact.position.copy(position);
                impact.position.y = 0.01;
                impact.rotation.x = -Math.PI / 2;

                impact.userData = {
                    scale: 0.1,
                    maxScale: 2,
                    growthSpeed: 8,
                    opacity: 0.8
                };

                this.shockwaves.push(impact);
                scene.add(impact);
            }

            createScreenFlash() {
                // ç®€å•çš„å±å¹•é—ªç™½æ•ˆæœ
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: white;
                    opacity: 0.8;
                    z-index: 9999;
                    pointer-events: none;
                `;
                document.body.appendChild(flash);

                setTimeout(() => {
                    flash.style.transition = 'opacity 0.3s';
                    flash.style.opacity = '0';
                    setTimeout(() => document.body.removeChild(flash), 300);
                }, 50);
            }

            update(deltaTime) {
                // æ›´æ–°ç¢ç‰‡
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    const data = particle.userData;

                    // åº”ç”¨é‡åŠ›
                    data.velocity.y += data.gravity * deltaTime;

                    // æ›´æ–°ä½ç½®
                    particle.position.add(data.velocity.clone().multiplyScalar(deltaTime));

                    // æ›´æ–°æ—‹è½¬
                    particle.rotation.x += data.rotationSpeed.x * deltaTime;
                    particle.rotation.y += data.rotationSpeed.y * deltaTime;
                    particle.rotation.z += data.rotationSpeed.z * deltaTime;

                    // åœ°é¢ç¢°æ’
                    if (particle.position.y <= 0.05) {
                        particle.position.y = 0.05;
                        data.velocity.y *= -0.3;
                        data.velocity.x *= 0.8;
                        data.velocity.z *= 0.8;
                        data.rotationSpeed.multiplyScalar(0.7);
                    }

                    // ç”Ÿå‘½å€¼é€’å‡
                    data.life -= deltaTime * 0.3;

                    if (data.life <= 0 || particle.position.y < -10) {
                        scene.remove(particle);
                        this.particles.splice(i, 1);
                        stats.activeParticles--;
                    }
                }

                // æ›´æ–°å†²å‡»æ³¢
                for (let i = this.shockwaves.length - 1; i >= 0; i--) {
                    const shockwave = this.shockwaves[i];
                    const data = shockwave.userData;

                    data.scale += data.growthSpeed * deltaTime;
                    shockwave.scale.setScalar(data.scale);

                    data.opacity -= deltaTime * 1.5;
                    shockwave.material.opacity = data.opacity;

                    if (data.opacity <= 0 || data.scale >= data.maxScale) {
                        scene.remove(shockwave);
                        this.shockwaves.splice(i, 1);
                    }
                }

                // æ›´æ–°å…‰æº
                for (let i = this.lights.length - 1; i >= 0; i--) {
                    const light = this.lights[i];
                    const data = light.userData;

                    data.intensity -= data.decaySpeed * deltaTime;
                    light.intensity = Math.max(0, data.intensity);

                    data.life -= deltaTime;

                    if (data.life <= 0 || data.intensity <= 0) {
                        scene.remove(light);
                        this.lights.splice(i, 1);
                    }
                }

                // æ›´æ–°ç«èŠ±
                for (let i = this.sparks.length - 1; i >= 0; i--) {
                    const spark = this.sparks[i];
                    const data = spark.userData;

                    // åº”ç”¨é‡åŠ›
                    data.velocity.y -= 9.8 * deltaTime;

                    // æ›´æ–°ä½ç½®
                    spark.position.add(data.velocity.clone().multiplyScalar(deltaTime));

                    data.life -= deltaTime * 2;
                    spark.material.opacity = data.life;

                    if (data.life <= 0 || spark.position.y < 0) {
                        scene.remove(spark);
                        this.sparks.splice(i, 1);
                        stats.activeParticles--;
                    }
                }

                // æ›´æ–°çƒŸé›¾
                for (let i = this.smoke.length - 1; i >= 0; i--) {
                    const smoke = this.smoke[i];
                    const data = smoke.userData;

                    // æ›´æ–°ä½ç½®
                    smoke.position.add(data.velocity.clone().multiplyScalar(deltaTime));

                    // ç¼“æ…¢ä¸Šå‡å’Œæ‰©æ•£
                    data.velocity.y += 0.5 * deltaTime;
                    data.velocity.multiplyScalar(0.98);

                    // å¢å¤§å°ºå¯¸
                    const scale = 1 + (1 - data.life) * 0.5;
                    smoke.scale.setScalar(scale * data.maxScale);

                    data.life -= deltaTime * 0.2;
                    smoke.material.opacity = data.life * 0.3;

                    if (data.life <= 0) {
                        scene.remove(smoke);
                        this.smoke.splice(i, 1);
                        stats.activeParticles--;
                    }
                }
            }

            dispose() {
                // æ¸…ç†æ‰€æœ‰ç²’å­
                [...this.particles, ...this.shockwaves, ...this.lights, ...this.sparks, ...this.smoke].forEach(obj => {
                    if (obj.parent) {
                        scene.remove(obj);
                    }
                });

                this.particles = [];
                this.shockwaves = [];
                this.lights = [];
                this.sparks = [];
                this.smoke = [];
            }
        }

        // è¿é”ååº”ç®¡ç†å™¨ç±»
        class ChainReactionManager {
            constructor() {
                this.pendingIgnitions = [];
                this.isChainActive = false;
            }

            triggerChainReaction(explosionPosition, sourceId) {
                const fireRange = 3; // ç«å…‰èŒƒå›´åŠå¾„

                // æŸ¥æ‰¾èŒƒå›´å†…çš„æœªçˆ†ç‚¸é­ç‚®
                firecrackers.forEach(firecracker => {
                    if (firecracker.id === sourceId || firecracker.isExploded || firecracker.isLit) {
                        return;
                    }

                    const distance = firecracker.position.distanceTo(explosionPosition);
                    if (distance <= fireRange) {
                        // è®¡ç®—å»¶è¿Ÿæ—¶é—´ï¼ˆ0.1-0.3ç§’éšæœºå»¶è¿Ÿï¼‰
                        const delay = 100 + Math.random() * (config.chainDelay - 100);

                        this.scheduleIgnition(firecracker, delay);
                    }
                });

                if (this.pendingIgnitions.length > 0) {
                    this.isChainActive = true;
                    stats.chainActive = true;
                    updateStats();
                }
            }

            scheduleIgnition(firecracker, delay) {
                const ignition = {
                    firecracker: firecracker,
                    time: Date.now() + delay
                };

                this.pendingIgnitions.push(ignition);
            }

            update() {
                const currentTime = Date.now();

                for (let i = this.pendingIgnitions.length - 1; i >= 0; i--) {
                    const ignition = this.pendingIgnitions[i];

                    if (currentTime >= ignition.time) {
                        ignition.firecracker.ignite();
                        this.pendingIgnitions.splice(i, 1);
                    }
                }

                // æ£€æŸ¥è¿é”ååº”æ˜¯å¦ç»“æŸ
                if (this.isChainActive && this.pendingIgnitions.length === 0) {
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†æ ‡è®°ä¸ºç»“æŸï¼Œç¡®ä¿æ‰€æœ‰çˆ†ç‚¸éƒ½å®Œæˆ
                    setTimeout(() => {
                        if (this.pendingIgnitions.length === 0) {
                            this.isChainActive = false;
                            stats.chainActive = false;
                            updateStats();

                            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é­ç‚®éƒ½å·²çˆ†ç‚¸
                            if (stats.remainingCount === 0) {
                                onAllFirecrackersExploded();
                            }
                        }
                    }, 1000);
                }
            }

            reset() {
                this.pendingIgnitions = [];
                this.isChainActive = false;
                stats.chainActive = false;
            }
        }

        // åˆå§‹åŒ–åœºæ™¯
        function init() {
            createScene();
            createLights();
            createGround();
            createGlassBox();
            createFirecrackers();
            setupEventListeners();

            // åˆå§‹åŒ–ç³»ç»Ÿ
            explosionSystem = new ExplosionSystem();
            chainReactionManager = new ChainReactionManager();

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();

            // éšè—åŠ è½½ç•Œé¢
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'block';
                updateStats();
            }, 2000);
        }

        function createScene() {
            // åœºæ™¯è®¾ç½®
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 100, 500);

            // ç›¸æœºè®¾ç½® - 45åº¦æ–œè§’ä¿¯è§†ï¼Œè·ç¦»ç®±å­çº¦15å•ä½
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);

            updateCameraPosition();

            // æ¸²æŸ“å™¨è®¾ç½®
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.getElementById('container').appendChild(renderer.domElement);

            // é¼ æ ‡æ§åˆ¶
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
        }

        function updateCameraPosition() {
            switch (config.cameraAngle) {
                case 'default':
                    // æ–œ45åº¦è§’ä¿¯è§†ï¼Œè·ç¦»ç®±å­çº¦15å•ä½
                    camera.position.set(15, 20, 15);
                    camera.lookAt(0, 4, 0);
                    break;
                case 'close':
                    camera.position.set(8, 12, 8);
                    camera.lookAt(0, 4, 0);
                    break;
                case 'side':
                    camera.position.set(20, 10, 0);
                    camera.lookAt(0, 4, 0);
                    break;
                case 'top':
                    camera.position.set(0, 30, 10);
                    camera.lookAt(0, 4, 0);
                    break;
            }
        }

        function createLights() {
            // ä¸»å…‰æº - 45åº¦è§’çš„å®šå‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(50, 80, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 200;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);

            // ç¯å¢ƒå…‰ - å¼ºåº¦0.4
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
        }

        function createGround() {
            const geometry = new THREE.PlaneGeometry(1000, 1000);
            const material = new THREE.MeshStandardMaterial({
                color: 0x808080,
                roughness: 0.8,
                metalness: 0.1
            });

            ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // æ·»åŠ ç½‘æ ¼è¾…åŠ©
            const gridHelper = new THREE.GridHelper(1000, 100, 0x666666, 0x999999);
            scene.add(gridHelper);
        }

        function createGlassBox() {
            const boxGroup = new THREE.Group();

            // ç»ç’ƒæè´¨
            const glassMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.15,
                roughness: 0.1,
                metalness: 0,
                clearcoat: 1.0,
                clearcoatRoughness: 0.0
            });

            // ç®±å­å°ºå¯¸ï¼š10Ã—10Ã—8
            const thickness = 0.1;

            // åº•é¢
            const bottomGeometry = new THREE.BoxGeometry(10, thickness, 10);
            const bottom = new THREE.Mesh(bottomGeometry, glassMaterial);
            bottom.position.y = 0;
            bottom.receiveShadow = true;
            boxGroup.add(bottom);

            // å››ä¸ªä¾§é¢
            const sideGeometry = new THREE.BoxGeometry(thickness, 8, 10);

            // å‰é¢
            const front = new THREE.Mesh(sideGeometry, glassMaterial);
            front.position.set(5, 4, 0);
            front.receiveShadow = true;
            boxGroup.add(front);

            // åé¢
            const back = new THREE.Mesh(sideGeometry, glassMaterial);
            back.position.set(-5, 4, 0);
            back.receiveShadow = true;
            boxGroup.add(back);

            // å·¦é¢
            const left = new THREE.Mesh(sideGeometry, glassMaterial);
            left.position.set(0, 4, -5);
            left.rotation.y = Math.PI / 2;
            left.receiveShadow = true;
            boxGroup.add(left);

            // å³é¢
            const right = new THREE.Mesh(sideGeometry, glassMaterial);
            right.position.set(0, 4, 5);
            right.rotation.y = Math.PI / 2;
            right.receiveShadow = true;
            boxGroup.add(right);

            // ä½ç½®ï¼šæ”¾ç½®åœ¨å¹³é¢ä¸­å¿ƒååçš„ä½ç½®
            boxGroup.position.set(0, 0, -5);

            glassBox = boxGroup;
            scene.add(glassBox);
        }

        function createFirecrackers() {
            firecrackers = [];
            let firecrackerId = 0;

            // ä»ç®±å­ä¸Šæ–¹5ä¸ªå•ä½é«˜åº¦å¤„ç”Ÿæˆé­ç‚®
            const spawnHeight = 13; // ç®±å­é¡¶éƒ¨é«˜åº¦8 + 5
            const groupSize = 10;
            const totalGroups = 10;

            for (let group = 0; group < totalGroups; group++) {
                for (let i = 0; i < groupSize; i++) {
                    // éšæœºä½ç½®
                    const x = (Math.random() - 0.5) * 8; // ç®±å­å†…éƒ¨èŒƒå›´
                    const z = (Math.random() - 0.5) * 8;
                    const y = spawnHeight + Math.random() * 2;

                    const position = new THREE.Vector3(x, y, z - 5); // ç®±å­ä½ç½®åç§»-5

                    const firecracker = new Firecracker(position, firecrackerId++);
                    firecrackers.push(firecracker);
                }
            }

            stats.totalFirecrackers = firecrackers.length;
            stats.remainingCount = firecrackers.length;
        }

        function startFireworks() {
            if (isAnimating) return;

            isAnimating = true;
            updateStatus('ç‡ƒæ”¾è¿›è¡Œä¸­...', 'active');
            document.getElementById('startButton').disabled = true;
            document.getElementById('startFireworks').disabled = true;

            // æŠ•æ·ä¸€ä¸ªå·²ç‚¹ç‡ƒçš„é­ç‚®
            const litFirecracker = new Firecracker(new THREE.Vector3(0, 25, 0), -1);
            litFirecracker.ignite();
            firecrackers.push(litFirecracker);

            // æŠ›ç‰©çº¿è½¨è¿¹è½å…¥ç®±å­
            litFirecracker.eject(8, new THREE.Vector3(0, -1, 0.5));
        }

        function resetScene() {
            isAnimating = false;
            singleDetonationMode = false;

            // æ¸…ç†æ‰€æœ‰é­ç‚®
            firecrackers.forEach(firecracker => firecracker.dispose());
            firecrackers = [];

            // æ¸…ç†çˆ†ç‚¸ç³»ç»Ÿ
            explosionSystem.dispose();

            // é‡ç½®è¿é”ååº”ç®¡ç†å™¨
            chainReactionManager.reset();

            // é‡æ–°åˆ›å»ºé­ç‚®
            createFirecrackers();

            // é‡ç½®ç»Ÿè®¡
            stats.explodedCount = 0;
            stats.remainingCount = stats.totalFirecrackers;
            stats.activeParticles = 0;
            stats.chainActive = false;

            updateStatus('åœºæ™¯å·²é‡ç½®');
            document.getElementById('startButton').disabled = false;
            document.getElementById('startFireworks').disabled = false;
            document.getElementById('modeIndicator').classList.remove('active');

            updateStats();
        }

        function toggleSingleDetonation() {
            singleDetonationMode = !singleDetonationMode;
            document.getElementById('modeIndicator').classList.toggle('active', singleDetonationMode);
            document.getElementById('singleDetonation').textContent =
                singleDetonationMode ? 'é€€å‡ºå•ä¸ªå¼•çˆ†' : 'ğŸ’¥ å•ä¸ªå¼•çˆ†æ¨¡å¼';

            updateStatus(singleDetonationMode ? 'å•ä¸ªå¼•çˆ†æ¨¡å¼å·²æ¿€æ´»' : 'å•ä¸ªå¼•çˆ†æ¨¡å¼å·²å…³é—­');
        }

        function onAllFirecrackersExploded() {
            isAnimating = false;
            updateStatus('ç‡ƒæ”¾å®Œæˆï¼', 'success');

            setTimeout(() => {
                document.getElementById('startButton').disabled = false;
                document.getElementById('startFireworks').disabled = false;
                updateStatus('å‡†å¤‡å°±ç»ª');
            }, 3000);
        }

        function setupEventListeners() {
            document.getElementById('startButton').addEventListener('click', startFireworks);
            document.getElementById('startFireworks').addEventListener('click', startFireworks);
            document.getElementById('resetScene').addEventListener('click', resetScene);
            document.getElementById('singleDetonation').addEventListener('click', toggleSingleDetonation);

            // å‚æ•°æ§åˆ¶
            document.getElementById('explosionPower').addEventListener('input', (e) => {
                config.explosionPower = parseInt(e.target.value) / 100;
                document.getElementById('powerValue').textContent = e.target.value;
            });

            document.getElementById('chainDelay').addEventListener('input', (e) => {
                config.chainDelay = parseInt(e.target.value);
                document.getElementById('delayValue').textContent = e.target.value;
            });

            document.getElementById('particleCount').addEventListener('input', (e) => {
                config.particleCount = parseInt(e.target.value);
                document.getElementById('particleValue').textContent = e.target.value;
            });

            document.getElementById('toggleEffects').addEventListener('click', () => {
                effectsEnabled = !effectsEnabled;
                updateStatus(effectsEnabled ? 'ç‰¹æ•ˆå·²å¯ç”¨' : 'ç‰¹æ•ˆå·²ç¦ç”¨');
            });

            document.getElementById('toggleSound').addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                updateStatus(soundEnabled ? 'éŸ³æ•ˆå·²å¯ç”¨' : 'éŸ³æ•ˆå·²ç¦ç”¨');
            });

            document.getElementById('toggleCamera').addEventListener('click', () => {
                const angles = ['default', 'close', 'side', 'top'];
                const currentIndex = angles.indexOf(config.cameraAngle);
                config.cameraAngle = angles[(currentIndex + 1) % angles.length];
                updateCameraPosition();
                updateStatus(`è§†è§’: ${config.cameraAngle}`);
            });

            // é¼ æ ‡ç‚¹å‡»äº‹ä»¶ï¼ˆå•ä¸ªå¼•çˆ†æ¨¡å¼ï¼‰
            renderer.domElement.addEventListener('click', (event) => {
                if (!singleDetonationMode) return;

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);

                // æ£€æµ‹ç‚¹å‡»çš„é­ç‚®
                const intersects = [];
                firecrackers.forEach(firecracker => {
                    if (!firecracker.isExploded && !firecracker.isLit) {
                        const distance = raycaster.ray.distanceToPoint(firecracker.position);
                        if (distance < 1) {
                            intersects.push({ distance, object: firecracker.group });
                        }
                    }
                });

                if (intersects.length > 0) {
                    intersects.sort((a, b) => a.distance - b.distance);
                    const clickedFirecracker = firecrackers.find(f => f.group === intersects[0].object);
                    if (clickedFirecracker) {
                        clickedFirecracker.ignite();
                        updateStatus('å·²ç‚¹ç‡ƒé€‰ä¸­çš„é­ç‚®');
                    }
                }
            });

            window.addEventListener('resize', onWindowResize);
        }

        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }

        function updateStats() {
            document.getElementById('remainingFirecrackers').textContent = stats.remainingCount;
            document.getElementById('explodedCount').textContent = stats.explodedCount;
            document.getElementById('chainActive').textContent = stats.chainActive ? 'æ˜¯' : 'å¦';
            document.getElementById('activeParticles').textContent = stats.activeParticles;

            const progress = stats.totalFirecrackers > 0 ?
                ((stats.explodedCount / stats.totalFirecrackers) * 100) : 0;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // æ€§èƒ½ç›‘æ§
        let lastTime = performance.now();
        let frameCount = 0;
        let fps = 60;

        function updateFPS() {
            frameCount++;
            const currentTime = performance.now();

            if (currentTime >= lastTime + 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fps').textContent = fps;
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;

            // æ›´æ–°é­ç‚®
            firecrackers.forEach(firecracker => firecracker.update(deltaTime));

            // æ›´æ–°çˆ†ç‚¸ç³»ç»Ÿ
            if (explosionSystem) {
                explosionSystem.update(deltaTime);
            }

            // æ›´æ–°è¿é”ååº”
            if (chainReactionManager) {
                chainReactionManager.update();
            }

            // æ›´æ–°FPS
            updateFPS();

            // æ¸²æŸ“
            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>