# BMAD 步骤文件指南

**版本：** 1.0
**模块：** bmb (BMAD Builder)
**目的：** 创建 BMAD 工作流步骤文件的权威指南

---

## 概述

BMAD 工作流步骤文件遵循严格的结构，以确保一致性、渐进式披露和模式感知路由。每个步骤文件必须遵守这些指南。

---

## 文件大小优化

**关键：** 保持步骤文件**小于200行**（绝对最大250行）。

如果步骤超过此限制：
- 考虑拆分为多个步骤
- 将内容提取到 `/data/` 参考文件
- 优化冗长的解释

---

## 必需的 Frontmatter 结构

关键：Frontmatter应仅包含步骤文件中使用的项目！

```yaml
---
name: 'step-2-foo.md'
description: '此步骤完成的简要描述'

# 文件引用 ## 关键：Frontmatter引用或变量应仅包含步骤文件中使用的项目！
outputFile: {bmb_creations_output_folder}/output-file-name.md
nextStepFile: './step-3-bar.md'

# 任务引用（根据需要）
advancedElicitationTask: '{project-root}/_bmad/core/workflows/advanced-elicitation/workflow.xml'
partyModeWorkflow: '{project-root}/_bmad/core/workflows/party-mode/workflow.md'
# ... 其他任务特定引用
---
```

### Frontmatter 字段描述

| 字段           | 必需     | 描述                               |
| --------------- | -------- | ---------------------------------- |
| `name`          | 是       | 步骤标识符（kebab-case）           |
| `description`   | 是       | 步骤目的的单行摘要                 |
| `outputFile`    | 是       | 结果文档化的位置                   |
| 任务引用        | 根据需要 | 外部工作流/任务的路径              |

---

## 文档结构

### 1. 标题

```markdown
# 步骤 X：[步骤名称]
```

### 2. 步骤目标

```markdown
## 步骤目标：

[单句说明此步骤完成的内容]
```

### 3. 角色强化

```markdown
### 角色强化：

- ✅ 你是一个[特定角色]，负责[做什么]
- ✅ 如果你已被分配名称、communication_style和身份，在扮演此新角色时继续使用这些
- ✅ 我们进行协作对话，而非命令-响应
- ✅ 你带来[你的专业知识]，用户带来[他们的专业知识]，共同[实现目标]
- ✅ 始终保持[语气/方法]
```

### 4. 语言偏好

```markdown
### 语言偏好：
用户已选择使用**{语言}**语言进行交流。
在此步骤中，你必须使用**{语言}**回应。
```

**重要：** 从跟踪文件（agentPlan、validationReport等）中读取 `userPreferences.language` 并强制执行。

### 5. 步骤特定规则

```markdown
### 步骤特定规则：

- 🎯 仅专注于[特定范围]
- 🚫 禁止[禁止的操作]
- 💬 方法：[如何参与]
- 📋 确保[特定结果]
```

### 6. 执行协议

```markdown
## 执行协议：

- [做什么 - 使用动词]
- [另一个操作]
- 🚫 禁止[禁止的操作]
```

### 7. 上下文边界

```markdown
## 上下文边界：

- 可用上下文：[可用的内容]
- 焦点：[关注的内容]
- 限制：[边界]
- 依赖：[此步骤依赖的内容]
```

### 8. 指令序列

```markdown
## 指令序列：

### 1. [第一个操作]

**[操作描述]**

### 2. [第二个操作]

...
```

### 9. 菜单选项

```markdown
### X. 呈现菜单选项

显示："**选择：** [A] [菜单项A] [P] [菜单项P] [C] [菜单项C]"

#### 菜单处理逻辑：
- 如果 A：执行 {advancedElicitationTask}，完成后重新显示菜单
- 如果 P：执行 {partyModeWorkflow}，完成后重新显示菜单
- 如果 C：保存内容到 {outputFile}，更新frontmatter，然后加载、读取整个文件，再执行 {nextStepFile}
- 如果有任何其他评论或查询：帮助用户回应，然后[重新显示菜单选项](#x-呈现菜单选项)

#### 执行规则：
- 始终在呈现菜单后暂停并等待用户输入
- 仅当用户选择 'C' 时才进行到下一步
- 其他菜单项执行后，返回到此菜单
- 用户可以聊天或提问 - 始终回应，然后再次显示菜单选项

## 关键步骤完成说明
仅当选择[C继续选项]且[完成条件]时，你才将完全加载并读取`{nextStepFile}`...
```

### 10. 系统成功/失败指标

```markdown
## 🚨 系统成功/失败指标

### ✅ 成功：
- [成功标准1]
- [成功标准2]
- ...

### ❌ 系统失败：
- [失败标准1]
- [失败标准2]
- ...

**主规则：** 跳过步骤、优化序列或不遵循确切指令是被禁止的，构成系统失败。
```

---

## A/P/C 菜单约定

BMAD 工作流使用固定菜单结构：

| 选项 | 含义               | 行为                               |
| ---- | ------------------ | ---------------------------------- |
| **A** | 高级启发           | 执行advancedElicitationTask，然后重新显示菜单 |
| **P** | 派对模式           | 执行partyModeWorkflow，然后重新显示菜单     |
| **C** | 继续/接受          | 保存输出、更新frontmatter、加载nextStepFile |
| 其他 | 自定义             | 每个步骤定义（如F=修复，X=退出）            |

**规则：**
- A 和 P 必须始终存在
- C 必须存在，除非是最后一步（使用 X 或类似项退出）
- A/P 后 → 重新显示菜单
- C 后 → 进行到下一步
- 可使用自定义字母作为步骤特定选项

---

## 渐进式披露

**核心原则：** 每个步骤仅知道其直接下一步。

### 实现

1. **绝不预加载未来步骤** - 仅在选择 [C] 时加载 `nextStepFile`

2. **模式感知路由**（用于共享步骤）：
   ```markdown
   ## 模式感知路由：
   ### 如果从CREATE模式进入：
   加载 ./s-next-step.md

   ### 如果从EDIT模式进入：
   加载 ./e-next-step.md

   ### 如果从VALIDATE模式进入：
   加载 ./v-next-step.md
   ```

3. **首先读取跟踪文件** - 始终读取跟踪文件（agentPlan、validationReport等）以确定当前模式和路由

---

## 模式感知路由（共享步骤）

共享步骤（`s-*.md`）必须根据跟踪文件中存储的模式进行路由。

### 跟踪文件 Frontmatter

```yaml
---
mode: create              # 或 edit | validate
stepsCompleted:
  - c-01-brainstorm.md
  - s-01-discovery.md
# ... 其他跟踪字段
---
```

### 路由实现

```markdown
## 完成路由：

1. 将 `./this-step-name.md` 追加到 {trackingFile}.stepsCompleted
2. 保存内容到 {trackingFile}
3. 读取 {trackingFile}.mode
4. 基于模式路由：

### 如果 mode == create：
加载 ./s-next-create-step.md

### 如果 mode == edit：
加载 ./e-next-edit-step.md

### 如果 mode == validate：
加载 ./s-next-validate-step.md
```

---

## 文件命名约定

### 三模工作流

| 前缀 | 含义              | 示例                  |
| ---- | ----------------- | --------------------- |
| `c-` | 创建特定          | `c-01-brainstorm.md`  |
| `e-` | 编辑特定          | `e-01-load-analyze.md`|
| `v-` | 验证特定          | `v-01-load-review.md` |
| `s-` | 2+模式共享        | `s-05-activation.md`  |

### 编号

- 在每个前缀类型内，顺序编号
- 为每个前缀类型重新编号（c-01、e-01、v-01、s-01）
- 使用字母表示子步骤（s-06a、s-06b、s-06c）

---

## 语言偏好强制执行

**关键：** 每个步骤必须尊重用户选择的语言。

### 实现

```markdown
### 语言偏好：
用户已选择使用**{语言}**语言进行交流。
在此步骤中，你必须使用**{语言}**回应。
```

### 读取语言偏好

从跟踪文件frontmatter：
```yaml
---
userPreferences:
  language: spanish    # 或任何语言
---
```

### 规则

- **必须**在步骤开始时从跟踪文件读取语言偏好
- **必须**对所有内容使用用户选择的语言回应
- **必须**在用户选择的语言中包含菜单选项
- **例外：** 技术术语、文件名和代码保持英文

---

## 数据文件引用

当步骤内容变得过大（>200行）时，提取到 `/data/` 文件：

### 何时提取

- 步骤文件超过200行
- 内容是参考材料（规则、示例、模式）
- 内容在多个步骤中重用

### 如何引用

```markdown
## 参考材料：

加载并引用：`../data/{data-file-name}.md`

该文件的关键点：
- [点1]
- [点2]
```

### 数据文件最佳实践

- 保持数据文件专注于单个主题
- 使用清晰、描述性的名称
- 包含示例和非示例
- 为LLM使用优化（简洁、结构化）

---

## 要避免的常见陷阱

### ❌ 不要：

- 预加载未来步骤（违反渐进式披露）
- 超过250行而不拆分
- 忘记更新 `stepsCompleted` 数组
- 忽略用户的语言偏好
- 在共享步骤中跳过模式检查
- 使用模糊的菜单选项字母（坚持A/P/C加上1-2个自定义）

### ✅ 要：

- 保持文件小于200行
- 首先读取跟踪文件
- 基于 `mode` 字段路由
- 在每个菜单中包含 A/P
- 使用描述性步骤名称
- 将复杂内容提取到数据文件

---

## 模板：新步骤文件

```markdown
---
name: 'step-name'
description: '此步骤的作用'

# 文件引用
thisStepFile: ./step-name.md
workflowFile: ../workflow.md
outputFile: {bmb_creations_output_folder}/output.md

# 任务引用
advancedElicitationTask: '{project-root}/_bmad/core/workflows/advanced-elicitation/workflow.xml'
partyModeWorkflow: '{project-root}/_bmad/core/workflows/party-mode/workflow.md'
---

# 步骤 X：[步骤名称]

## 步骤目标：

[单句目标]

### 角色强化：

- ✅ 你是一个[角色]，负责[做什么]
- ✅ 如果你已被分配名称、communication_style和身份，在扮演此新角色时继续使用这些
- ✅ 我们进行协作对话，而非命令-响应
- ✅ 你带来[专业知识]，用户带来[专业知识]，共同[实现]
- ✅ 始终保持[语气]

### 语言偏好：
用户已选择使用**{语言}**语言进行交流。
在此步骤中，你必须使用**{语言}**回应。

### 步骤特定规则：

- 🎯 仅专注于[范围]
- 🚫 禁止[禁止的操作]
- 💬 方法：[如何参与]
- 📋 确保[结果]

## 执行协议：

- [操作1]
- [操作2]
- 🚫 禁止[禁止的操作]

## 上下文边界：

- 可用上下文：[可用的内容]
- 焦点：[关注的内容]
- 限制：[边界]
- 依赖：[依赖关系]

## 指令序列：

### 1. [第一个操作]

**第一个操作的描述**

### 2. [第二个操作]

**第二个操作的描述**

...

### X. 呈现菜单选项

显示："**选择：** [A] 高级启发 [P] 派对模式 [C] 继续"

#### 菜单处理逻辑：
- 如果 A：执行 {advancedElicitationTask}，完成后重新显示菜单
- 如果 P：执行 {partyModeWorkflow}，完成后重新显示菜单
- 如果 C：保存内容到 {outputFile}，更新frontmatter，然后加载、读取整个文件，再执行 {nextStepFile}
- 如果有任何其他评论或查询：帮助用户回应，然后[重新显示菜单选项](#x-呈现菜单选项)

#### 执行规则：
- 始终在呈现菜单后暂停并等待用户输入
- 仅当用户选择 'C' 时才进行到下一步
- 其他菜单项执行后，返回到此菜单
- 用户可以聊天或提问 - 始终回应，然后再次显示菜单选项

## 关键步骤完成说明
仅当选择[C继续选项]且[条件]时，你才将完全加载并读取`{nextStepFile}`...

## 🚨 系统成功/失败指标

### ✅ 成功：
- [成功标准]

### ❌ 系统失败：
- [失败标准]

**主规则：** 跳过步骤、优化序列或不遵循确切指令是被禁止的，构成系统失败。
```

---

**指南结束**
