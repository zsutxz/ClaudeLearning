<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¡€ä¸‰æ¶ˆæ¸¸æˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        
        .game-container {
            text-align: center;
        }
        
        h1 {
            color: #333;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 50px);
            grid-gap: 2px;
            margin: 20px auto;
            background-color: #333;
            padding: 10px;
            border-radius: 10px;
        }
        
        .gem {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .gem.special {
            animation: pulse 1s infinite;
            box-shadow: 0 0 10px gold;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .gem.swap-animation {
            transition: transform 0.3s ease;
        }
        
        .gem.match-animation {
            animation: matchEffect 0.5s forwards;
        }
        
        @keyframes matchEffect {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        .gem.fall-animation {
            transition: top 0.5s ease;
        }
        
        .gem:hover {
            transform: scale(1.1);
        }
        
        .gem.selected {
            border: 3px solid #fff;
            box-shadow: 0 0 10px #fff;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .score-board {
            font-size: 20px;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .moves {
            font-size: 18px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>åŸºç¡€ä¸‰æ¶ˆæ¸¸æˆ</h1>
        <div class="score-board">å¾—åˆ†: <span id="score">0</span></div>
        <div class="moves">å‰©ä½™æ­¥æ•°: <span id="moves">30</span></div>
        <div class="game-board" id="gameBoard"></div>
        <div class="controls">
            <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
        </div>
        
        <div class="instructions">
            <h3>æ¸¸æˆè¯´æ˜:</h3>
            <p>1. ç‚¹å‡»ä¸€ä¸ªå®çŸ³ï¼Œç„¶åç‚¹å‡»ç›¸é‚»çš„å®çŸ³è¿›è¡Œäº¤æ¢</p>
            <p>2. å½¢æˆä¸‰ä¸ªæˆ–ä»¥ä¸Šç›¸åŒå®çŸ³çš„è¿çº¿å³å¯æ¶ˆé™¤</p>
            <p>3. ç›®æ ‡æ˜¯åœ¨æ­¥æ•°ç”¨å®Œå‰è·å¾—å°½å¯èƒ½é«˜çš„åˆ†æ•°</p>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const BOARD_SIZE = 8;
        const GEM_TYPES = ['ğŸ”´', 'ğŸ”µ', 'ğŸŸ¢', 'ğŸŸ¡', 'ğŸŸ£', 'ğŸŸ '];
        const SPECIAL_GEMS = ['ğŸŒˆ', 'ğŸ§¨', 'ğŸ”®']; // å½©è™¹ gem, ç‚¸å¼¹, é­”æ³•çƒ
        const INITIAL_MOVES = 30;
        
        // éŸ³æ•ˆç³»ç»Ÿ
        let audioContext;
        let sounds = {};
        
        // æ¸¸æˆçŠ¶æ€
        let board = [];
        let score = 0;
        let moves = INITIAL_MOVES;
        let selectedGem = null;
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            board = [];
            score = 0;
            moves = INITIAL_MOVES;
            selectedGem = null;
            
            document.getElementById('score').textContent = score;
            document.getElementById('moves').textContent = moves;
            
            // åˆå§‹åŒ–éŸ³æ•ˆ
            initAudio();
            
            createBoard();
            renderBoard();
        }
        
        // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                createSounds();
            } catch (e) {
                console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
            }
        }
        
        // åˆ›å»ºéŸ³æ•ˆ
        function createSounds() {
            if (!audioContext) return;
            
            // åˆ›å»ºç‚¹å‡»éŸ³æ•ˆ
            sounds.click = createTone(440, 0.1); // AéŸ³
            
            // åˆ›å»ºåŒ¹é…éŸ³æ•ˆ
            sounds.match = createTone(523.25, 0.3); // CéŸ³
            
            // åˆ›å»ºç‰¹æ®Šå®çŸ³éŸ³æ•ˆ
            sounds.special = createTone(784, 0.5); // GéŸ³
            
            // åˆ›å»ºæ¸¸æˆç»“æŸéŸ³æ•ˆ
            sounds.gameOver = createTone(220, 1); // AéŸ³ä½å…«åº¦
        }
        
        // åˆ›å»ºéŸ³è°ƒ
        function createTone(frequency, duration) {
            return function() {
                if (!audioContext) return;
                
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.value = frequency;
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (e) {
                    console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
                }
            };
        }
        
        // æ’­æ”¾éŸ³æ•ˆ
        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName]();
            }
        }
        
        // åˆ›å»ºæ¸¸æˆæ¿
        function createBoard() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                board[i] = [];
                for (let j = 0; j < BOARD_SIZE; j++) {
                    board[i][j] = getRandomGem();
                }
            }
            
            // ç¡®ä¿åˆå§‹çŠ¶æ€æ²¡æœ‰å·²æœ‰åŒ¹é…
            while (hasMatches()) {
                removeMatches();
                fillEmptySpaces();
            }
        }
        
        // è·å–éšæœºå®çŸ³
        function getRandomGem() {
            return GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)];
        }
        
        // æ¸²æŸ“æ¸¸æˆæ¿
        function renderBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    const gem = document.createElement('div');
                    gem.className = 'gem';
                    gem.textContent = board[i][j];
                    gem.dataset.row = i;
                    gem.dataset.col = j;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šå®çŸ³
                    if (SPECIAL_GEMS.includes(board[i][j])) {
                        gem.classList.add('special');
                    }
                    
                    gem.addEventListener('click', () => handleGemClick(i, j));
                    gameBoard.appendChild(gem);
                }
            }
        }
        
        // å¤„ç†å®çŸ³ç‚¹å‡»
        function handleGemClick(row, col) {
            // å¦‚æœæ²¡æœ‰å‰©ä½™æ­¥æ•°ï¼Œæ¸¸æˆç»“æŸ
            if (moves <= 0) return;
            
            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            playSound('click');
            
            // å¦‚æœæ²¡æœ‰é€‰ä¸­å®çŸ³ï¼Œé€‰ä¸­å½“å‰å®çŸ³
            if (!selectedGem) {
                selectedGem = { row, col };
                updateSelectionVisual(row, col);
                return;
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„å®çŸ³ï¼Œå–æ¶ˆé€‰ä¸­
            if (selectedGem.row === row && selectedGem.col === col) {
                selectedGem = null;
                clearSelectionVisual();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
            if (areAdjacent(selectedGem.row, selectedGem.col, row, col)) {
                // å°è¯•äº¤æ¢
                swapGems(selectedGem.row, selectedGem.col, row, col);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
                if (hasMatches()) {
                    // æœ‰æ•ˆç§»åŠ¨
                    moves--;
                    document.getElementById('moves').textContent = moves;
                    
                    // å¤„ç†åŒ¹é…
                    processMatches();
                } else {
                    // æ— æ•ˆç§»åŠ¨ï¼Œæ¢å›æ¥
                    swapGems(selectedGem.row, selectedGem.col, row, col);
                }
            } else {
                // ä¸ç›¸é‚»ï¼Œé€‰æ‹©æ–°çš„å®çŸ³
                clearSelectionVisual();
            }
            
            selectedGem = { row, col };
            updateSelectionVisual(row, col);
        }
        
        // æ›´æ–°é€‰ä¸­è§†è§‰æ•ˆæœ
        function updateSelectionVisual(row, col) {
            clearSelectionVisual();
            const gem = document.querySelector(`.gem[data-row="${row}"][data-col="${col}"]`);
            if (gem) gem.classList.add('selected');
        }
        
        // æ¸…é™¤é€‰ä¸­è§†è§‰æ•ˆæœ
        function clearSelectionVisual() {
            const selected = document.querySelector('.gem.selected');
            if (selected) selected.classList.remove('selected');
        }
        
        // æ£€æŸ¥ä¸¤ä¸ªå®çŸ³æ˜¯å¦ç›¸é‚»
        function areAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }
        
        // äº¤æ¢ä¸¤ä¸ªå®çŸ³
        function swapGems(row1, col1, row2, col2) {
            const temp = board[row1][col1];
            board[row1][col1] = board[row2][col2];
            board[row2][col2] = temp;
            renderBoard();
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
        function hasMatches() {
            // æ£€æŸ¥æ°´å¹³åŒ¹é…
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE - 2; j++) {
                    if (board[i][j] !== '' && 
                        board[i][j] === board[i][j+1] && 
                        board[i][j] === board[i][j+2]) {
                        return true;
                    }
                }
            }
            
            // æ£€æŸ¥å‚ç›´åŒ¹é…
            for (let i = 0; i < BOARD_SIZE - 2; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    if (board[i][j] !== '' && 
                        board[i][j] === board[i+1][j] && 
                        board[i][j] === board[i+2][j]) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // å¤„ç†åŒ¹é…
        function processMatches() {
            while (hasMatches()) {
                const matches = findMatches();
                animateMatches(matches);
                setTimeout(() => {
                    removeMatches(matches);
                    updateScore(matches.length);
                    fillEmptySpaces();
                    renderBoard();
                }, 500);
            }
        }
        
        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…
        function findMatches() {
            const matches = [];
            
            // æŸ¥æ‰¾æ°´å¹³åŒ¹é…
            for (let i = 0; i < BOARD_SIZE; i++) {
                let count = 1;
                for (let j = 1; j < BOARD_SIZE; j++) {
                    if (board[i][j] !== '' && board[i][j] === board[i][j-1]) {
                        count++;
                    } else {
                        if (count >= 3) {
                            // åˆ›å»ºç‰¹æ®Šå®çŸ³
                            if (count >= 5) {
                                // å½©è™¹å®çŸ³ (5ä¸ªæˆ–æ›´å¤š)
                                const rainbowRow = i;
                                const rainbowCol = j - Math.floor(count/2);
                                board[rainbowRow][rainbowCol] = SPECIAL_GEMS[0];
                            } else if (count === 4) {
                                // çº¿æ¸…é™¤å®çŸ³ (4ä¸ª)
                                const lineClearRow = i;
                                const lineClearCol = j - Math.floor(count/2);
                                board[lineClearRow][lineClearCol] = SPECIAL_GEMS[2];
                            }
                            
                            for (let k = j - count; k < j; k++) {
                                matches.push({row: i, col: k});
                            }
                        }
                        count = 1;
                    }
                }
                if (count >= 3) {
                    // åˆ›å»ºç‰¹æ®Šå®çŸ³
                    if (count >= 5) {
                        // å½©è™¹å®çŸ³ (5ä¸ªæˆ–æ›´å¤š)
                        const rainbowRow = i;
                        const rainbowCol = BOARD_SIZE - Math.floor(count/2) + 1;
                        board[rainbowRow][rainbowCol] = SPECIAL_GEMS[0];
                    } else if (count === 4) {
                        // çº¿æ¸…é™¤å®çŸ³ (4ä¸ª)
                        const lineClearRow = i;
                        const lineClearCol = BOARD_SIZE - Math.floor(count/2) + 1;
                        board[lineClearRow][lineClearCol] = SPECIAL_GEMS[2];
                    }
                    
                    for (let k = BOARD_SIZE - count; k < BOARD_SIZE; k++) {
                        matches.push({row: i, col: k});
                    }
                }
            }
            
            // æŸ¥æ‰¾å‚ç›´åŒ¹é…
            for (let j = 0; j < BOARD_SIZE; j++) {
                let count = 1;
                for (let i = 1; i < BOARD_SIZE; i++) {
                    if (board[i][j] !== '' && board[i][j] === board[i-1][j]) {
                        count++;
                    } else {
                        if (count >= 3) {
                            // åˆ›å»ºç‰¹æ®Šå®çŸ³
                            if (count >= 5) {
                                // å½©è™¹å®çŸ³ (5ä¸ªæˆ–æ›´å¤š)
                                const rainbowRow = i - Math.floor(count/2);
                                const rainbowCol = j;
                                board[rainbowRow][rainbowCol] = SPECIAL_GEMS[0];
                            } else if (count === 4) {
                                // çº¿æ¸…é™¤å®çŸ³ (4ä¸ª)
                                const lineClearRow = i - Math.floor(count/2);
                                const lineClearCol = j;
                                board[lineClearRow][lineClearCol] = SPECIAL_GEMS[2];
                            }
                            
                            for (let k = i - count; k < i; k++) {
                                matches.push({row: k, col: j});
                            }
                        }
                        count = 1;
                    }
                }
                if (count >= 3) {
                    // åˆ›å»ºç‰¹æ®Šå®çŸ³
                    if (count >= 5) {
                        // å½©è™¹å®çŸ³ (5ä¸ªæˆ–æ›´å¤š)
                        const rainbowRow = BOARD_SIZE - Math.floor(count/2) + 1;
                        const rainbowCol = j;
                        board[rainbowRow][rainbowCol] = SPECIAL_GEMS[0];
                    } else if (count === 4) {
                        // çº¿æ¸…é™¤å®çŸ³ (4ä¸ª)
                        const lineClearRow = BOARD_SIZE - Math.floor(count/2) + 1;
                        const lineClearCol = j;
                        board[lineClearRow][lineClearCol] = SPECIAL_GEMS[2];
                    }
                    
                    for (let k = BOARD_SIZE - count; k < BOARD_SIZE; k++) {
                        matches.push({row: k, col: j});
                    }
                }
            }
            
            // å»é™¤é‡å¤çš„åŒ¹é…
            return matches.filter((match, index, self) => 
                index === self.findIndex(m => m.row === match.row && m.col === match.col)
            );
        }
        
        // ç§»é™¤åŒ¹é…çš„å®çŸ³
        function removeMatches(matches) {
            matches.forEach(match => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šå®çŸ³
                if (SPECIAL_GEMS.includes(board[match.row][match.col])) {
                    // å¤„ç†ç‰¹æ®Šå®çŸ³æ•ˆæœ
                    activateSpecialGem(match.row, match.col, board[match.row][match.col]);
                }
                board[match.row][match.col] = '';
            });
        }
        
        // åŠ¨ç”»åŒ¹é…æ•ˆæœ
        function animateMatches(matches) {
            matches.forEach(match => {
                const gem = document.querySelector(`.gem[data-row="${match.row}"][data-col="${match.col}"]`);
                if (gem) {
                    gem.classList.add('match-animation');
                }
            });
            
            // æ’­æ”¾åŒ¹é…éŸ³æ•ˆ
            if (matches.length > 0) {
                playSound('match');
            }
        }
        
        // å¡«å……ç©ºä½
        function fillEmptySpaces() {
            // ä»ä¸‹å¾€ä¸Šå¤„ç†æ¯ä¸€åˆ—
            for (let j = 0; j < BOARD_SIZE; j++) {
                let emptySpaces = 0;
                for (let i = BOARD_SIZE - 1; i >= 0; i--) {
                    if (board[i][j] === '') {
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        board[i + emptySpaces][j] = board[i][j];
                        board[i][j] = '';
                    }
                }
                
                // å¡«å……é¡¶éƒ¨çš„ç©ºä½
                for (let i = 0; i < emptySpaces; i++) {
                    board[i][j] = getRandomGem();
                }
            }
        }
        
        // æ¿€æ´»ç‰¹æ®Šå®çŸ³æ•ˆæœ
        function activateSpecialGem(row, col, gemType) {
            // æ’­æ”¾ç‰¹æ®Šå®çŸ³éŸ³æ•ˆ
            playSound('special');
            
            switch(gemType) {
                case 'ğŸŒˆ': // å½©è™¹å®çŸ³ - æ¸…é™¤æ‰€æœ‰åŒç±»å‹å®çŸ³
                    // å½©è™¹å®çŸ³æ•ˆæœï¼šæ¸…é™¤æ‰€æœ‰åŒç±»å‹æ™®é€šå®çŸ³
                    for (let i = 0; i < BOARD_SIZE; i++) {
                        for (let j = 0; j < BOARD_SIZE; j++) {
                            if (GEM_TYPES.includes(board[i][j])) {
                                board[i][j] = '';
                            }
                        }
                    }
                    break;
                case 'ğŸ§¨': // ç‚¸å¼¹ - æ¸…é™¤3x3åŒºåŸŸ
                    // ç‚¸å¼¹æ•ˆæœï¼šæ¸…é™¤3x3åŒºåŸŸ
                    for (let i = Math.max(0, row - 1); i <= Math.min(BOARD_SIZE - 1, row + 1); i++) {
                        for (let j = Math.max(0, col - 1); j <= Math.min(BOARD_SIZE - 1, col + 1); j++) {
                            board[i][j] = '';
                        }
                    }
                    break;
                case 'ğŸ”®': // çº¿æ¸…é™¤å®çŸ³ - æ¸…é™¤æ•´è¡Œæˆ–æ•´åˆ—
                    // çº¿æ¸…é™¤æ•ˆæœï¼šæ¸…é™¤æ•´è¡Œå’Œæ•´åˆ—
                    for (let i = 0; i < BOARD_SIZE; i++) {
                        board[i][col] = '';
                    }
                    for (let j = 0; j < BOARD_SIZE; j++) {
                        board[row][j] = '';
                    }
                    break;
            }
        }
        
        // æ›´æ–°åˆ†æ•°
        function updateScore(matchesCount) {
            score += matchesCount * 10;
            document.getElementById('score').textContent = score;
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (moves <= 0) {
                setTimeout(() => {
                    alert(`æ¸¸æˆç»“æŸï¼æ‚¨çš„æœ€ç»ˆå¾—åˆ†æ˜¯: ${score}`);
                }, 300);
            }
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            initGame();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = initGame;
    </script>
</body>
</html>